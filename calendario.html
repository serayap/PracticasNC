<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Distribuci√≥n Formulario + Calendario + Listado</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="calendario.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        let usuarioActual = {};
       
        function actualizarUI() {
            document.getElementById('tituloReservas').textContent = `Reservas de pr√°cticas con Carlos`;

            mostrarCreditosUsuario();
            cargarTimeSlots();
            cargarDias();
            cargarReservas();

            document.getElementById('formReserva').addEventListener('submit', crearReserva);
            document.getElementById('contenidoAyuda').innerHTML = ayudaCalendario;
        }

        function dct(e) {
            const bytes = CryptoJS.AES.decrypt(e, "34#-2?579/fbh%$l(O√±h05t@");
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        }
        const firebaseConfig = dct("U2FsdGVkX1/wVoGGAPam24EP2C4b4c5OTPYzVoVmcY3hFxXHl+PfMkhFPUbKc8cRmwTvM44kMrg2sXgyT1mMB5/t3bUiIjIQDe1suqcD2SMvW7RVdJ1jCasaAMGo7a529bxkmCH6zKx+5iysRXw5PIzCKpUh1IGyItrCekPNJjt6zk4g8tP3qDNZizE4u62WVlvG4tp68iHasgwgYWkgzHhuN5/aYc4cRumfEDLPzz1Yf0EbSk3QM5QeGQDGficRCyNbgyaFbqj83wnjHWX4kZQ2iKddEdtNUqqjYHe0Mc0n5YI31rLP5o9dtAONCrrFRadsW0bfVC1ZCQWm5/JoLsi/6Xgxv0Oy3f7b8ncnNbCtsiYZhkgsPn7v2TU+CH/LBm5rUeVTji6lKNh2CYHs+A==");

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        // Inicializa Firestore si no lo has hecho
        const db = firebase.firestore();

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            
            try {
                const q = await db.collection('usuarios_registrados')
                    .where('usuarioId', '==', user.uid)
                    .get();
                if (!q.empty) {
                    usuarioActual.id = q.docs[0].id;
                    usuarioActual.nombre = q.docs[0].data().nombre;
                    usuarioActual.email = q.docs[0].data().email;
                    usuarioActual.perfil = q.docs[0].data().perfil;
                    usuarioActual.uid = user.uid;
                    
                    // Control de acceso por perfil
                    if (usuarioActual.perfil !== "alumno") {
                        window.location.href = "index.html";
                        return;
                    }

                    document.body.classList.remove("oculto");

                    if (document.readyState === 'loading') {                        
                        document.addEventListener('DOMContentLoaded', actualizarUI);
                    } else {
                        actualizarUI();
                    }
                } else {
                    console.warn("No existe documento para ese usuarioId en usuarios_registrados");
                    window.location.href = "index.html";
                }
            } catch (err) {
                console.error("Error buscando documento de usuario registrado:", err);
                window.location.href = "index.html";
            }
        });

    </script>

</head>
<body class="oculto">
    <div class="container">
        <h2 class="cabecera-principal" id="tituloReservas"></h2>
        <div id="subcabecera-creditos" class="subcabecera-creditos">
            <span id="creditosUsuario">...</span>
        </div>
        <div class="arriba">
            <div>
                <div class="form-reserva">
                    <h2 class="cabecera">Nueva solicitud de reserva</h2>
                    <form id="formReserva">
                        <div class="form-row">
                            <label for="dia">D√≠a:</label>
                            <select id="dia" required></select>
                            <label for="hora">Hora:</label>
                            <select id="hora" required></select>
                        </div>
                        <!--<div class="form-row">
                            <label for="hora">Hora:</label>
                            <select id="hora" required></select>
                        </div>-->
                        <div class="form-row">
                            <input type="checkbox" id="bloqueSemana" class="block-week">
                            <label for="bloqueSemana">Reservar este horario para 5 dias seguidos</label>
                        </div>
                        <button type="submit" class="cta-btn-solicitar">Solicitar reserva</button>
                        <div id="addreservaMsg"></div>
                    </form>
                </div>
                <div class="form-reserva">
                    <h2 class="cabecera">Mis solicitudes de reservas</h2>
                    <!-- Aqu√≠ tu listado -->
                    <div id="lista-reservas"></div>
                    <div id="reservaMsg"></div>
                </div>
            </div>
            <div id="calendar-container">
                <div id="calendar"></div>
                <!-- Leyenda de colores -->
                <div class="leyenda-colores">
                    <span class="leyenda-item"><span class="dot dot-pendiente"></span>Pendiente</span>
                    <span class="leyenda-item"><span class="dot dot-confirmada"></span>Confirmada</span>
                    <span class="leyenda-item"><span class="dot dot-examen"></span>Examen</span>
                </div>
                <div class="seccion-derecha">
                    <div class="reservas-dia">
                        <h2 class="cabecera" id="tituloReservasDia">Reservas del d√≠a</h2>
                        <div id="lista-reservas-dia"></div>
                    </div>
                    <button id="btnAyuda" class="btn-ayuda">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
                <!--<div class="seccion-derecha">
                        <div class="reservas-dia">
                            <h2 class="cabecera" id="tituloReservasDia">Reservas del d√≠a</h2>
                            <div id="lista-reservas-dia"></div>
                        </div>
                    </div>-->
            </div>
        </div>
    </div>
    <div id="popupAyuda" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h2>Ayuda</h2>
            <div id="contenidoAyuda">
                <!-- Aqu√≠ va el contenido de ayuda espec√≠fico para cada p√°gina -->
            </div>
        </div>
    </div>
    <script>        
        
        const settings = { experimentalForceLongPolling: true, merge: true };
        db.settings(settings);
        
        let calendar = null;
        let primeraCarga = true;
        let reservasTodas = {};
        let reservasUsuario = [];
        //let usuarioActual = null;
        let eventos = [];

        async function getUsuarioRegistradoDoc(uid) {
            const q = await db.collection("usuarios_registrados")
                .where("usuarioId", "==", uid)
                .get();
            if (!q.empty) {
                return q.docs[0]; // Devuelve el DocumentSnapshot
            }
            return null;
        }

        async function mostrarCreditosUsuario() {
            const doc = await getUsuarioRegistradoDoc(usuarioActual.uid);
            if (!doc) {
                document.getElementById("creditosUsuario").textContent = "No disponible";
                return;
            }
            const datos = doc.data();
            const creditos = datos.creditos !== undefined && datos.creditos !== null ? Number(datos.creditos) : 0;
            const nombre = capitalizarPrimeraLetra(datos.nombre || "");
            document.getElementById("creditosUsuario").textContent = "Clases para reservar de " + nombre + ": " + creditos;
            //console.table(datos);
        }

        function capitalizarPrimeraLetra(str) {
            return str.replace(/\b\w/g, function (char) {
                return char.toUpperCase();
            });
        }

        // Utilidad: formato YYYY-MM-DD
        function toISODate(date) {
            return date.toISOString().split('T')[0];
        }

        // Cargar d√≠as de la semana actual y la siguiente
        function cargarDias() {
            const selectDia = document.getElementById('dia');
            selectDia.innerHTML = "";
            const hoy = new Date();
            for (let i = 1; i < 15; i++) {
                const fecha = new Date(hoy);
                fecha.setDate(hoy.getDate() + i);
                const diaSemana = fecha.getDay(); // 0=domingo, 6=s√°bado
                if (diaSemana !== 0 && diaSemana !== 6) { // Excluye s√°bados y domingos
                    const fechaISO = toISODate(fecha);
                    //const texto = fecha.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                    const texto = formatDateForDisplay(fecha);
                    const option = document.createElement('option');
                    option.value = fechaISO;
                    option.textContent = texto.charAt(0).toUpperCase() + texto.slice(1);
                    selectDia.appendChild(option);
                }

            }
        }

        // Cargar horas desde firestore
        async function cargarTimeSlots() {
            try {
                const h = await db.collection("configuracion").doc("horarios").get();
                timeSlots = h.data().slots;
                //console.log("Tramos horarios cargados:", timeSlots);
            } catch (error) {
                console.error("Error al cargar los tramos horarios:", error);
                // Usar valores por defecto si hay error
                timeSlots = ["07:30 a 08:50", "09:00 a 10:20", "10:30 a 11:50", "12:00 a 13:20", "13:30 a 14:50"];
            }

            // A√±ade cada tramo como opci√≥n
            const selectHora = document.getElementById('hora');
            if (!selectHora) return;

            // Limpia las opciones anteriores
            selectHora.innerHTML = '';

            timeSlots.forEach(timeslot => {
                if (timeslot != "15:10 a 16:30") {
                    const option = document.createElement('option');
                    option.value = timeslot;
                    option.textContent = timeslot;
                    selectHora.appendChild(option);
                }
                    
            });
        }

        // Funci√≥n para cargar reservas del d√≠a
        async function cargarReservasDelDia(fechaStr) {
            const lista = document.getElementById('lista-reservas-dia');
            lista.innerHTML = '<div class="cargando">Cargando...</div>';

            try {
                // Actualizar t√≠tulo con formato "Reservas del lunes, 12 de mayo"
                const tituloDia = document.getElementById('tituloReservasDia');
                if (tituloDia) {
                    const fecha = new Date(fechaStr);
                    tituloDia.textContent = `Reservas del ${fecha.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long'
                    })}`;
                }

                // Consulta a Firestore (sin ordenar)
                const fechaInicio = new Date(fechaStr + 'T00:00:00');
                const fechaFin = new Date(fechaStr + 'T23:59:59');
                const q = db.collection("reservas")
                    .where("fecha", ">=", fechaInicio)
                    .where("fecha", "<=", fechaFin)
                    .where('estado', 'in', ['confirmada', 'pendiente', 'examen']); // Solo estos estados

                const querySnapshot = await q.get();
                lista.innerHTML = '';

                if (querySnapshot.empty) {
                    lista.innerHTML = '<div class="sin-reservas"><em>No hay reservas este d√≠a</em></div>';
                    return;
                }

                // Convertir documentos a array y filtrar horas inv√°lidas
                const reservas = [];
                querySnapshot.forEach(doc => {
                    const reserva = doc.data();
                    if (reserva.hora && typeof reserva.hora === 'string') {
                        reservas.push(reserva);
                    }
                });

                // Depuraci√≥n: ver horas originales y minutos calculados
                //console.log("Reservas sin ordenar:", reservas.map(r => r.hora));

                // Ordenar por hora de inicio (ascendente)
                reservas.sort((a, b) => {
                    return horaAminutos(a.hora) - horaAminutos(b.hora);
                });

                // Depuraci√≥n: ver orden despu√©s de ordenar
                //console.log("Reservas ordenadas:", reservas.map(r => r.hora));

                // Mostrar en el DOM
                reservas.forEach(reserva => {
                    const div = document.createElement('div');
                    div.className = `reserva-dia-item ${reserva.estado}`;

                    // Formato visual mejorado
                    div.innerHTML = `
                        <div class="reserva-hora">
                            <span class="hora">${reserva.hora}</span>
                            <span class="estado ${reserva.estado}">${reserva.estado}</span>
                        </div>
                    `;
                    lista.appendChild(div);
                });

            } catch (error) {
                console.error("Error:", error);
                lista.innerHTML = '<div class="error">Error al cargar reservas</div>';
            }
        }

        function horaAminutos(horaRango) {
            try {
                const [inicio] = horaRango.split(' a '); // Extrae la hora inicial
                const [hora, minutos] = inicio.split(':').map(Number);
                return hora * 60 + minutos;
            } catch (error) {
                console.error("Error al parsear la hora:", horaRango);
                return 0; // Si hay error, trata como 0 minutos (puedes ajustarlo)
            }
        }


        function mostrarEventosDelDia(fechaStr) {
            const eventos = calendar.getEvents();
            const eventosDelDia = eventos.filter(evento => {
                const inicio = evento.start?.toISOString().split('T')[0];
                return inicio === fechaStr;
            });

            //console.log("Eventos en", fechaStr, ":", eventosDelDia);
        }

        // Inicializar FullCalendar
        function inicializarCalendario() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                alert("No se encontr√≥ el div con id 'calendar'");
                return;
            }

            const fechaActual = new Date(); // O fija la fecha si es para pruebas
            const year = fechaActual.getFullYear();
            const month = fechaActual.getMonth(); // 0-indexed

            // Primer d√≠a del mes actual
            const start = new Date(year, month, 1);
            // √öltimo d√≠a del mes siguiente
            const end = new Date(year, month + 2, 0); // D√≠a 0 del mes+2 es el √∫ltimo del mes+1

            calendar = new FullCalendar.Calendar(calendarEl, {
                //plugins: [dayGridPlugin, interactionPlugin],
                initialView: 'dayGridMonth',
                locale: 'es',
                titleFormat: { year: 'numeric', month: 'long' },
                firstDay: 1,
                validRange: {
                    start: start.toISOString().split('T')[0],
                    end: end.toISOString().split('T')[0]
                },
                //height: 'auto',
                aspectRatio: 0.8, // Menor = m√°s compacto verticalmente
                fixedWeekCount: false, // Elimina filas vac√≠as
                expandRows: false, // Evita que las filas se expandan
                //events: [],
                dateClick: function (info) {
                    cargarReservasDelDia(info.dateStr);
                },
                /*dayCellDidMount: (info) => {
                    cargarReservasDelDia(info.dateStr);
                    const fecha = info.date.toISOString().split('T')[0];

                    // A√±adir event listener al elemento de la celda
                    info.el.addEventListener('click', () => {
                        mostrarEventosDelDia(fecha);
                 });*/
                /*eventDidMount: function (info) {
                    // Colores seg√∫n estado
                    if (info.event.extendedProps.estado === 'pendiente') {
                        info.el.style.backgroundColor = '#ff9800';
                        info.el.style.borderColor = '#ff9800';
                    }
                    if (info.event.extendedProps.estado === 'confirmada') {
                        info.el.style.backgroundColor = '#4caf50';
                        info.el.style.borderColor = '#4caf50';
                    }
                },*/
                /*dayCellDidMount: function (info) {
                    // Corrige la fecha para la zona horaria local
                    const fechaLocal = new Date(info.date.getTime() - (info.date.getTimezoneOffset() * 60000)).toISOString().slice(0, 10); // Formato YYYY-MM-DD local

                    // 2. Verifica que la fecha exista en reservasTodas
                    const reservas = reservasTodas[fechaLocal] || { confirmadas: 0, pendientes: 0 };
                    console.log('Fecha:', fechaLocal, 'Pendientes:', reservas.pendientes);

                    if (reservas.pendientes > 0) {
                        //setTimeout(() => {
                            let eventsContainer = info.el.querySelector('.fc-daygrid-day-events');
                            if (!eventsContainer) {
                                eventsContainer = document.createElement('div');
                                //eventsContainer.className = 'fc-daygrid-day-events';
                                const frame = info.el.querySelector('.fc-daygrid-day-frame');
                                if (frame) frame.appendChild(eventsContainer);
                            }
                            const dot = document.createElement('div');
                            //dot.className = 'fc-dot-custom';
                            //dot.style.cssText = 'width:20px;height:20px;border-radius:50%;background:#FF9800;margin:2px auto;';
                            dot.style.cssText = 'width: 18px;height: 18px;border - radius: 50 %;background: #FF9800;margin: 0 auto;margin - top: 2px;display: flex;align - items: center;justify - content: center;color: black;font - size: 12px;font - weight: bold;';
                            dot.textContent = reservas.pendiente;
                            eventsContainer.appendChild(dot);
                        //}, 50);
                    }
                }*/
                dayCellContent: function (info) {
                    // Corrige la fecha para la zona horaria local
                    const fechaLocal = new Date(info.date.getTime() - (info.date.getTimezoneOffset() * 60000)).toISOString().slice(0, 10); // Formato YYYY-MM-DD local

                    // 2. Verifica que la fecha exista en reservasTodas
                    const reservas = reservasTodas[fechaLocal] || { confirmadas: 0, pendientes: 0 };
                    let dotp = '', dotc = '', dote = '';
                    if (reservas.examen > 0) {
                        dotp = `<span style = "display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #e0e0e0;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.examen}</span>`;
                    }
                    if (reservas.pendientes > 0) {
                        dotp = `<span style = "display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #FF9800;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.pendientes}</span>`;
                    }
                    if (reservas.confirmadas > 0) {
                        dotc = `<span style = "display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #4CAF50;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.confirmadas}</span>`;
                    }
                    return { html: info.dayNumberText + dote + dotp + dotc };
                }
            });
            calendar.render();
        }

        // Mostrar todas las reservas en el calendario
        function mostrarReservasCalendario() {
            //console.table(reservasTodas);
            calendar.removeAllEvents();
            const eventos = Object.values(reservasTodas)
                .flatMap(reservasDelDia =>
                    reservasDelDia.reservas.map(r => ({
                        start: r.fecha.toDate ? r.fecha.toDate() : r.fecha,
                        backgroundColor: r.estado === 'confirmada' ? '#4CAF50' : '#FF9800',
                        textColor: '#fff'
                    }))
                );
            //console.table(eventos);
            calendar.addEventSource(eventos);
        }

        // Mostrar reservas del usuario autenticado
        function mostrarReservasUsuario() {
            const lista = document.getElementById('lista-reservas');
            lista.innerHTML = "";
            if (reservasUsuario.length === 0) {
                lista.innerHTML = "<em>No tienes reservas a√∫n.</em>";
                return;
            }
            //console.table(reservasUsuario);
            reservasUsuario
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
                .forEach(r => {
                    const div = document.createElement('div');
                    div.className = `reserva-item ${r.estado}`;
                    const fechaTexto = new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });                    
                    if (r.estado == 'pendiente') div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">üìÖ ${new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</span ><span class="reserva-hora">‚è∞ ${r.hora}</span ><button onclick="anularReserva('${r.fecha}', '${r.hora}', 'pendiente')" class='cta-btn-pendiente'>anular</button></div>`;
                    //if (r.estado == 'confirmada') div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">üìÖ ${new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</span ><span class="reserva-hora">‚è∞ ${r.hora}</span ><div class='cta-btn'style ='background: linear-gradient(90deg, #56ab2f 30%, #a8e063 100%); box-shadow: 0 4px 16px rgba(255, 65, 108, 0.15);'>confirmada</div></div>`;
                    if (r.estado == 'confirmada') {

                        if (esMenosDe24Horas(r.fecha, r.hora)) {
                            // Bot√≥n deshabilitado
                            div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">üìÖ ${fechaTexto}</span><span class="reserva-hora">‚è∞ ${r.hora}</span><button disabled class='cta-btn-confirmada-disabled' title="No se puede anular a menos de 24h o reservas pasadas">confirmada</button></div>`;
                        } else {
                            div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">üìÖ ${new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</span ><span class="reserva-hora">‚è∞ ${r.hora}</span ><button onclick="anularReserva('${r.fecha}', '${r.hora}', 'confirmada')" class='cta-btn-confirmada'>confirmada</button></div>`;

                        }
                    }
                    //if (r.estado == 'anulada') div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">üìÖ ${new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</span ><span class="reserva-hora">‚è∞ ${r.hora}</span ><div class='cta-btn'style ='background: linear-gradient(90deg, #ff6a6a 30%, #ffe0e0 100%);'>anulada</div></div>`;

                    lista.appendChild(div);
                });
        }

        // Funci√≥n para saber si faltan menos de 24h para la reserva
        function esMenosDe24Horas(fechaStr, horaStr) {
            // fechaStr: 'YYYY-MM-DD', horaStr: 'HH:MM a HH:MM'
            const ahora = new Date();
            const [anio, mes, dia] = fechaStr.split('-').map(Number);
            const horaInicioStr = horaStr.split('a')[0].trim(); // "HH:MM"
            const [h, m] = horaInicioStr.split(':').map(Number);
            const fechaHoraReserva = new Date(anio, mes - 1, dia, h, m, 0, 0);
            const diferenciaMs = fechaHoraReserva - ahora;
            const horasRestantes = diferenciaMs / (1000 * 60 * 60);
            return horasRestantes < 24;
        }

        async function cargarReservas() {
            // Todas las reservas para el calendario
            if (!usuarioActual.uid) {
                console.error("usuarioActual.uid no est√° definido. No se puede cargar reservas del usuario.");
                return;
            }

            db.collection('reservas').onSnapshot(snapshot => {
                reservasTodas = {};
                snapshot.forEach(doc => {
                    const reserva = doc.data();
                    //console.log(reserva);
                    if (reserva.fecha?.toDate) { // Validar existencia de fecha
                        const fechaDate = reserva.fecha.toDate();
                        // Convertir a fecha local (ej: Espa√±a)
                        const fechaStr = fechaDate.toLocaleDateString("es-ES", {
                            timeZone: "Europe/Madrid",
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit"
                        }).split("/").reverse().join("-"); // Formato YYYY-MM-DD

                        if (!reservasTodas[fechaStr]) {
                            reservasTodas[fechaStr] = { confirmadas: 0, pendientes: 0, examen: 0 };
                        }

                        if (reserva.estado === 'examen') reservasTodas[fechaStr].examen++;
                        if (reserva.estado === 'confirmada') reservasTodas[fechaStr].confirmadas++;
                        if (reserva.estado === 'pendiente') reservasTodas[fechaStr].pendientes++;
                        //console.log("Datos cargados (LOCALES):", reservasTodas);
                    } else {
                        console.error("Documento sin campo 'fecha':", doc.id);
                    }

                    //console.log("Datos actualizados (LOCALES):", reservasTodas);
                    if (calendar) calendar.refetchEvents(); // Actualizar calendario
                });

                // Solo inicializa el calendario la primera vez
                if (primeraCarga) {
                    inicializarCalendario();
                    primeraCarga = false;
                }
                //console.table(reservasTodas);
                //console.log("Datos actualizados:", reservasTodas);
                //mostrarReservasCalendario();
            });


            // Reservas del usuario autenticado
            db.collection('reservas')
                .where('usuarioId', '==', usuarioActual.uid)
                .onSnapshot(snapshot => {
                    reservasUsuario = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.fecha?.toDate) {
                            const fechaLocal = d.fecha.toDate();
                            const fechaStr = fechaLocal.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }).split('/').reverse().join('-');
                            //console.log(fechaStr);
                            reservasUsuario.push({
                                ...d,
                                fecha: fechaStr,
                                id: doc.id
                            });
                        } else {
                            console.error("Documento del usuario sin 'fecha' v√°lida:", doc.id);
                        }
                    });
                    //console.table(reservasUsuario);
                    mostrarReservasUsuario();
                });
        }

        // Crear reservas (una o bloque semanal)
        async function crearReserva(e) {
            e.preventDefault();
            const reservaMsg = document.getElementById('reservaMsg');
            reservaMsg.textContent = "";
            const lista = document.getElementById('lista-reservas-dia');
            lista.innerHTML = '';
            const tituloDia = document.getElementById('tituloReservasDia');
            tituloDia.textContent = "Reservas del dia";

            const dia = document.getElementById('dia').value;
            const hora = document.getElementById('hora').value.trim(); // Asegurar sin espacios
            const bloque = document.getElementById('bloqueSemana').checked;
            let fechas = [dia];

            // 1. Obtener usuario y cr√©ditos
            const usuarioDoc = await getUsuarioRegistradoDoc(usuarioActual.uid);
            if (!usuarioDoc || !usuarioDoc.exists) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.textContent = "Error: Usuario no encontrado";
                return;
            }
            const datos = usuarioDoc.data();
            const creditos = typeof datos.creditos === "number" ? datos.creditos : 0;

            // 2. Generar fechas para bloque semanal
            if (bloque) {
                let fechaActual = new Date(dia);
                fechas = [];
                let diasLaborables = 0;

                while (diasLaborables < 5) {
                    fechaActual.setDate(fechaActual.getDate() + 1);
                    const diaSemana = fechaActual.getDay();
                    if (diaSemana !== 0 && diaSemana !== 6) {
                        fechas.push(toISODate(fechaActual));
                        diasLaborables++;
                    }
                }
            }
            const creditosNecesarios = fechas.length;

            // 3. Verificar cr√©ditos
            if (creditos < creditosNecesarios) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.innerHTML = `No tienes clases suficientes para reservar.<br>Necesitas: ${creditosNecesarios} clases. Dispones: ${creditos} clases`;
                return;
            }

            // 4. Verificar disponibilidad
            for (const fecha of fechas) {
                const fechaFirestore = new Date(fecha);

                // 4.1. Verificar reserva existente del usuario
                const yaTieneReserva = await db.collection('reservas')
                    .where('fecha', '==', fechaFirestore)
                    .where('usuarioId', '==', usuarioActual.uid)
                    .where('estado', 'in', ['confirmada', 'pendiente'])
                    .where('hora', '==', hora)
                    .get();

                if (!yaTieneReserva.empty) {
                    const fechaFormateada = formatDateForDisplay(fechaFirestore);
                    reservaMsg.style.color = "#d32f2f";
                    reservaMsg.innerHTML = `Ya tienes una reserva el ${fechaFormateada}.<br>No puedes reservar m√°s en la misma fecha y hora.`;
                    return;
                }

                // 4.2. Verificar reserva confirmada de otro usuario
                const reservaOcupada = await db.collection('reservas')
                    .where('fecha', '==', fechaFirestore)
                    .where('hora', '==', hora)
                    .where('estado', '==', 'confirmada')
                    .get();

                const otraReserva = reservaOcupada.docs.find(doc =>
                    doc.data().usuarioId !== usuarioActual.uid
                );

                if (otraReserva) {
                    const fechaFormateada = formatDateForDisplay(fechaFirestore);
                    reservaMsg.style.color = "#d32f2f";
                    reservaMsg.innerHTML = `Ya existe una reserva confirmada para ${fechaFormateada} a las ${hora}.<br>Por favor, selecciona otro tramo.`;
                    return;
                }
            }

            // 5. Crear reservas
            const reservasImplicadas = [];
            const batch = db.batch(); // Usar batch para m√∫ltiples escrituras

            for (const fecha of fechas) {
                const reservaRef = db.collection('reservas').doc();
                batch.set(reservaRef, {
                    usuarioId: usuarioActual.uid,
                    usuarioNombre: datos.nombre || usuarioActual.email,
                    fecha: firebase.firestore.Timestamp.fromDate(new Date(fecha)),
                    hora: hora,
                    estado: 'pendiente',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                reservasImplicadas.push({
                    id: reservaRef.id,
                    fecha: fecha,
                    hora: hora
                });
            }

            // 6. Actualizar cr√©ditos
            const nuevosCreditos = creditos - creditosNecesarios;
            batch.update(db.collection("usuarios_registrados").doc(usuarioDoc.id), {
                creditos: nuevosCreditos
            });

            // Ejecutar batch
            await batch.commit();

            // 7. Actualizar UI
            if (typeof mostrarCreditosUsuario === "function") {
                mostrarCreditosUsuario();
            }

            // 8. Registrar en log
            await logCredito({
                usuarioId: datos.usuarioId,
                email: datos.email || usuarioActual.email,
                perfil: datos.perfil,
                creditosAntes: creditos,
                tipo: "restar",
                creditosDespues: nuevosCreditos,
                reservasImplicadas: reservasImplicadas
            });

            // 9. Mensaje de √©xito
            reservaMsg.style.color = "#388e3c";
            reservaMsg.innerHTML = "Reserva(s) solicitada(s) correctamente.<br>RECUERDA: cuando se confirme, tienes hasta 24 horas antes para anularla.";
            document.getElementById('formReserva').reset();

            // 10. Actualizar calendario si es necesario
            if (typeof calendar !== 'undefined' && typeof calendar.render === 'function') {
                calendar.render();
            }
        }

        // Funci√≥n auxiliar para formatear fechas
        function formatDateForDisplay(date) {
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'short'
            });
        }



        async function anularReserva(fechaStr, hora, estado) {
            try {
                const lista = document.getElementById('lista-reservas-dia');
                lista.innerHTML = '';
                const tituloDia = document.getElementById('tituloReservasDia');
                tituloDia.textContent = "Reservas del dia"

                // 1. Convertir fecha a Timestamp
                const [anio, mes, dia] = fechaStr.split('-').map(Number);
                const inicioDia = firebase.firestore.Timestamp.fromDate(new Date(anio, mes - 1, dia, 0, 0, 0, 0));
                const finDia = firebase.firestore.Timestamp.fromDate(new Date(anio, mes - 1, dia, 23, 59, 59, 999));
                //console.log("Rango de b√∫squeda:", inicioDia.toDate(), finDia.toDate());
                //console.log(usuarioActual.uid);

                // 2. Buscar reservas en ese d√≠a y hora
                const q = await db.collection("reservas")
                    .where("fecha", ">=", inicioDia)
                    .where("fecha", "<=", finDia)
                    .where("hora", "==", hora)
                    .where("estado", "==", estado)
                    .where("usuarioId", "==", usuarioActual.uid.trim()) // <-- Filtro por usuario
                    .get();

                if (q.empty) {
                    reservaMsg.textContent = "No se encontr√≥ la reserva para anular.";
                    return;
                }
                //console.log("Reservas encontradas:", q.docs.map(d => d.data()));
                // 3. Actualizar estado a "anulada" y contar cu√°ntas se anulan
                let reservasAnuladas = 0;
                const updatePromises = [];
                const reservasImplicadas = [];

                q.forEach((doc) => {
                    updatePromises.push(doc.ref.update({ estado: "anulada" }));
                    reservasAnuladas++;

                    const reserva = doc.data();
                    reservasImplicadas.push({
                        id: doc.id,
                        fecha: reserva.fecha.toDate().toISOString().split('T')[0], // YYYY-MM-DD
                        hora: reserva.hora
                    });
                });
                await Promise.all(updatePromises);
                //console.log("Reservas anuladas:", reservasAnuladas);

                // 4. Sumar clases a los cr√©ditos del usuario
                const clasesASumar = reservasAnuladas;

                // Obtener cr√©ditos actuales
                const userDocRef = db.collection("usuarios_registrados").doc(usuarioActual.id);
                const userDoc = await userDocRef.get();
                const datos = userDoc.data();
                const creditosActuales = datos && typeof datos.creditos === "number" ? datos.creditos : 0;

                // Actualizar cr√©ditos
                await userDocRef.update({
                    creditos: creditosActuales + clasesASumar
                });

                // Llama al log de creditos
                await logCredito({
                    usuarioId: datos.usuarioId,
                    email: datos.email,
                    perfil: datos.perfil,
                    creditosAntes: creditosActuales,
                    tipo: "sumar",
                    creditosDespues: creditosActuales + clasesASumar,
                    reservasImplicadas: reservasImplicadas
                });

                // (Opcional) Actualizar visualizaci√≥n de cr√©ditos
                if (typeof mostrarCreditosUsuario === "function") {
                    mostrarCreditosUsuario();
                }

                reservaMsg.style.color = "#388e3c";
                reservaMsg.innerHTML = `Reserva anulada correctamente.<br>Se han sumado ${clasesASumar} clases a tus cr√©ditos.`;
                calendar.render();
            } catch (error) {
                //console.error("Error al anular la reserva:", error);
                alert("Error al anular la reserva.");
            }
        }


        function parseFechaFirestore(fechaStr) {
            // Traducir el mes de espa√±ol a ingl√©s
            const meses = {
                'enero': 'Enero', 'febrero': 'Febrero', 'marzo': 'Marzo', 'abril': 'Abril', 'mayo': 'Mayo',
                'junio': 'Junio', 'julio': 'Julio', 'agosto': 'Agosto', 'septiembre': 'Septiembre', 'octubre': 'Octubre',
                'noviembre': 'Noviembre', 'diciembre': 'Diciembre'
            };
            let fechaEn = fechaStr;
            for (let [es, en] of Object.entries(meses)) {
                if (fechaEn.includes(es)) {
                    fechaEn = fechaEn.replace(es, en);
                    break;
                }
            }
            // Eliminar 'UTC+2' y ajustar am/pm
            fechaEn = fechaEn.split(' UTC')[0]
                .replace(' a.m.', ' AM')
                .replace(' p.m.', ' PM')
                .replace(' de ', ' ');

            // Parsear a Date
            // Ejemplo: '12 May 2025, 2:00:00 AM'
            const fechaDate = new Date(Date.parse(fechaEn));

            // Ajustar a UTC si es necesario (ejemplo: restar 2 horas si era UTC+2)
            // En este ejemplo, la hora ya est√° en local, as√≠ que para UTC:
            fechaDate.setHours(fechaDate.getHours() - 2);

            return fechaDate;
        }

        async function logCredito({
            usuarioId,
            email,
            perfil,
            creditosAntes,
            tipo, // "sumar" o "restar"
            creditosDespues,
            reservasImplicadas
        }) {
            try {
                await db.collection("logcreditos").add({
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    usuarioId,
                    email,
                    perfil,
                    creditosAntes,
                    tipo,
                    creditosDespues,
                    reservasImplicadas
                });
                //console.log("Log de cr√©dito guardado correctamente");
            } catch (error) {
                console.error("Error al guardar el log de cr√©ditos:", error);
            }
        }

        const btnAyuda = document.getElementById('btnAyuda');
        const popupAyuda = document.getElementById('popupAyuda');
        const closeBtn = document.querySelector('.close');

        const ayudaCalendario = `<h3>Uso de las reservas para las practicas</h3>
<p>Aqu√≠ puedes ver todas las reservas solicitadas al profesor de practicas. Ver√°s el numero de clases que te quedan por realizar. Podr√°s solicitar practicas, anularlas y ver si el profesor las ha confirmado.</p>
<ul>
    <li><strong>Calendario:</strong> Podr√°s ver todas las peticiones de reservas al profesor de practicas solicitadas por todos los alumnos, ya esten pendientes de confirmar por √©l, √≥ bien ya confirmadas.</li>
    <li><strong>Nueva solicitud de reserva:</strong> Podr√°s solicitar una reserva, eligiendo el dia y hora. Si chequeas la opcion de "Reservar este horario para 5 dias seguidos" se haran reserva de 5 dias a partir del dia elegido y a la misma hora.</li>
    <li><strong>Mis solicitudes de reserva:</strong> Visualizar√°s un listado con s√≥lo tus solicitudes de reservas de pr√°cticas. En el listado podr√°s anular las solicitudes, ya est√©n en el estado de "pendientes" √≥ "confirmadas". Pero estas √∫ltimas tiene un l√≠mite para su anulaci√≥n de hasta 24 horas antes del dia y hora de las reserva.</li>
    <li><strong>Reservas del d√≠a:</strong> Si haces clic en una fecha del calendario, visualizaras en este apartado todas las reservas solicitadas por todos los alumnos para ese dia tanto si est√°n pendientes como confirmadas.</li>
</ul>
`;

        btnAyuda.addEventListener('click', () => {
            popupAyuda.style.display = 'flex';
        });

        closeBtn.addEventListener('click', () => {
            popupAyuda.style.display = 'none';
        });

        // Cierra el popup si se hace clic fuera del contenido
        popupAyuda.addEventListener('click', (e) => {
            if (e.target === popupAyuda) {
                popupAyuda.style.display = 'none';
            }
        });  

    </script>
</body>
</html>
