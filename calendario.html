<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Distribuci√≥n Formulario + Calendario + Listado</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="calendario.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        let usuarioActual = {};
       
        function actualizarUI() {
            document.getElementById('tituloReservas').textContent = `Reservas de pr√°cticas con Carlos`;

            mostrarCreditosUsuario();
            cargarTimeSlots();
            cargarDias();
            cargarReservas();

            document.getElementById('formReserva').addEventListener('submit', crearReserva);
            document.getElementById('contenidoAyuda').innerHTML = ayudaCalendario;
            document.getElementById('contenidoInfo').innerHTML = infoNormas;
            document.getElementById('contenidoHolidays').innerHTML = infoVacaciones;
        }

        function dct(e) {
            const bytes = CryptoJS.AES.decrypt(e, "34#-2?579/fbh%$l(O√±h05t@");
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        }
        const firebaseConfig = dct("U2FsdGVkX1/wVoGGAPam24EP2C4b4c5OTPYzVoVmcY3hFxXHl+PfMkhFPUbKc8cRmwTvM44kMrg2sXgyT1mMB5/t3bUiIjIQDe1suqcD2SMvW7RVdJ1jCasaAMGo7a529bxkmCH6zKx+5iysRXw5PIzCKpUh1IGyItrCekPNJjt6zk4g8tP3qDNZizE4u62WVlvG4tp68iHasgwgYWkgzHhuN5/aYc4cRumfEDLPzz1Yf0EbSk3QM5QeGQDGficRCyNbgyaFbqj83wnjHWX4kZQ2iKddEdtNUqqjYHe0Mc0n5YI31rLP5o9dtAONCrrFRadsW0bfVC1ZCQWm5/JoLsi/6Xgxv0Oy3f7b8ncnNbCtsiYZhkgsPn7v2TU+CH/LBm5rUeVTji6lKNh2CYHs+A==");

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        // Inicializa Firestore si no lo has hecho
        const db = firebase.firestore();
        let unsubscribeCreditos = null;

        console.log("Auth state changed triggered");

        auth.onAuthStateChanged(async user => {
            if (!user) {
                console.log("No hay usuario autenticado");
                window.location.href = "index.html";
                return;
            }
            console.log("Usuario autenticado:", user.uid);
            
            try {
                const q = await db.collection('usuarios_registrados')
                    .where('usuarioId', '==', user.uid)
                    .get();
                if (!q.empty) {
                    usuarioActual.id = q.docs[0].id;
                    usuarioActual.nombre = q.docs[0].data().nombre;
                    usuarioActual.email = q.docs[0].data().email;
                    usuarioActual.perfil = q.docs[0].data().perfil;
                    usuarioActual.uid = user.uid;
                    usuarioActual.info = q.docs[0].data().info;
                    console.log("Documento usuario actual:", usuarioActual.id);
                    // Control de acceso por perfil
                    if (usuarioActual.perfil !== "alumno") {
                        window.location.href = "index.html";
                        return;
                    }

                    document.body.classList.remove("oculto");

                    // Iniciar el listener para cr√©ditos
                    if (unsubscribeCreditos) {
                        unsubscribeCreditos(); // cancelar si exist√≠a escuchador
                        console.log("Listener anterior cancelado");
                    }

                    unsubscribeCreditos = escucharCreditosUsuario(usuarioActual.uid);

                    if (document.readyState === 'loading') {                        
                        document.addEventListener('DOMContentLoaded', actualizarUI);
                    } else {
                        actualizarUI();
                    }
                } else {
                    console.log("No existe documento para ese usuarioId en usuarios_registrados");
                    window.location.href = "index.html";
                }
            } catch (err) {
                console.log("Error buscando documento de usuario registrado:", err);
                window.location.href = "index.html";
            }
        });

    </script>

</head>
<body class="oculto">
    <div class="container">
        <h2 class="cabecera-principal" id="tituloReservas"></h2>
        <div id="subcabecera-creditos" class="subcabecera-creditos">
            <span id="creditosUsuario">...</span>
        </div>
        <div class="arriba">
            <div>
                <div class="form-reserva">
                    <h2 class="cabecera">Nueva solicitud de reserva</h2>
                    <form id="formReserva">
                        <div class="form-row">
                            <label for="dia">D√≠a:</label>
                            <select id="dia" required></select>
                            <label for="hora">Hora:</label>
                            <select id="hora" required></select>
                        </div>
                        <!--<div class="form-row">
                            <label for="hora">Hora:</label>
                            <select id="hora" required></select>
                        </div>-->
                        <div class="form-row">
                            <input type="checkbox" id="bloqueSemana" class="block-week">
                            <label for="bloqueSemana">Reservar este horario para 5 dias seguidos</label>
                        </div>
                        <button type="submit" class="cta-btn-solicitar">Solicitar reserva</button>
                        <div id="addreservaMsg"></div>
                    </form>
                </div>
                <div class="form-reserva">
                    <h2 class="cabecera">Mis solicitudes de reservas</h2>
                    <!-- Aqu√≠ tu listado -->
                    <div id="lista-reservas"></div>
                    <div id="reservaMsg"></div>
                </div>
            </div>
            <div id="calendar-container">
                <div id="calendar"></div>
                <!-- Leyenda de colores -->
                <div class="leyenda-colores">
                    <span class="leyenda-item"><span class="dot dot-pendiente"></span>Pendiente</span>
                    <span class="leyenda-item"><span class="dot dot-confirmada"></span>Confirmada</span>
                    <span class="leyenda-item"><span class="dot dot-examen"></span>Examen</span>
                </div>
                <div class="seccion-derecha">
                    <div class="reservas-dia">
                        <h2 class="cabecera" id="tituloReservasDia">Reservas del d√≠a</h2>
                        <div id="lista-reservas-dia"></div>
                    </div>
                    <button id="btnAyuda" class="btn-ayuda">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
                <!--<div class="seccion-derecha">
                        <div class="reservas-dia">
                            <h2 class="cabecera" id="tituloReservasDia">Reservas del d√≠a</h2>
                            <div id="lista-reservas-dia"></div>
                        </div>
                    </div>-->
            </div>
        </div>
    </div>
    <div id="popupInfo" class="popup">
        <div class="popup-content">
            <span class="closeInfo">&times;</span>
            <h2>Normas de las clases Practicas</h2>
            <div id="contenidoInfo">
                <!-- Aqu√≠ va el contenido de ayuda espec√≠fico para cada p√°gina -->
            </div>
            <button class="btnInfo" id="btnInfo">Entendido</button>
        </div>
    </div>
    <div id="popupHolidays" class="popup">
        <div class="popup-content">
            <span class="closeHolidays">&times;</span>
            <h2>Cierre de las clases Practicas por vacaciones</h2>
            <div id="contenidoHolidays">
                <!-- Aqu√≠ va el contenido de ayuda espec√≠fico para cada p√°gina -->
            </div>
        </div>
    </div>
    <div id="popupAyuda" class="popup">
        <div class="popup-content">
            <span class="closeAyuda">&times;</span>
            <h2>Ayuda</h2>
            <div id="contenidoAyuda">
                <!-- Aqu√≠ va el contenido de ayuda espec√≠fico para cada p√°gina -->
            </div>
        </div>
    </div>
    <script>
        // ====================== CONFIGURACI√ìN INICIAL FIRESTORE ======================
        // Configuramos Firestore para mayor robustez en entornos m√≥viles/lentos.
        const settings = { experimentalForceLongPolling: true, merge: true };
        db.settings(settings); // Solo lo ejecutas una vez al inicio

        let calendar = null;           // Referencia global del calendario principal
        let primeraCarga = true;       // Controla la primera renderizaci√≥n del calendario
        let reservasTodas = {};        // Hash agrupado por fechas para mostrar resumen en el calendario
        let reservasUsuario = [];      // Reservas activas del usuario que ha iniciado sesi√≥n
        let cacheReservasPorDia = {};  // Cach√© local (memoria) para reservas por d√≠a: evita lecturas repetidas

        // ====================== UTILIDADES GENERALES ======================

        /**
         * Devuelve la cadena con la primera letra may√∫scula en cada palabra.
         * √ötil para nombres, apellidos, etc.
         */
        function capitalizarPrimeraLetra(str) {
            return str.replace(/\b\w/g, char => char.toUpperCase());
        }

        // Utilidad para transformar fechas a formato ISO yyyy-mm-dd
        function toISODate(date) {
            return date.toISOString().split('T')[0];
        }

        // Convierte rango hora a minutos para ordenar
        function horaAminutos(horaRango) {
            try {
                const [inicio] = horaRango.split(' a ');
                const [hora, minutos] = inicio.split(':').map(Number);
                return hora * 60 + minutos;
            } catch (error) {
                console.error("Error al parsear la hora:", horaRango);
                return 0;
            }
        }

        // Utilidad de formato local para fechas
        function formatDateForDisplay(date) {
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'short'
            });
        }

        // --- Carga los d√≠as laborables para selecci√≥n de fechas ---
        // No requiere cach√©, ya que se calcula localmente y es muy eficiente.
        function cargarDias() {
            const selectDia = document.getElementById('dia');
            selectDia.innerHTML = "";
            const hoy = new Date();
            for (let i = 1; i < 15; i++) {
                const fecha = new Date(hoy);
                fecha.setDate(hoy.getDate() + i);
                const diaSemana = fecha.getDay();
                if (diaSemana !== 0 && diaSemana !== 6) { // Excluye fines de semana
                    const fechaISO = toISODate(fecha);
                    const texto = formatDateForDisplay(fecha);
                    const option = document.createElement('option');
                    option.value = fechaISO;
                    option.textContent = texto.charAt(0).toUpperCase() + texto.slice(1);
                    selectDia.appendChild(option);
                }
            }
        }

        // --- Carga tramos horarios con cach√© local para minimizar lecturas ---
        // Sotene cach√© en localStorage con JSON. Actualiza solo si no est√° cacheado.
        async function cargarTimeSlots() {
            const cacheKey = "timeSlotsCache";
            const cacheData = localStorage.getItem(cacheKey);
            if (cacheData) {
                try {
                    timeSlots = JSON.parse(cacheData);
                    cargarOpcionesHorarios();
                    return;
                } catch {
                    localStorage.removeItem(cacheKey);
                }
            }
            try {
                const doc = await db.collection("configuracion").doc("horarios").get();
                timeSlots = doc.data().slots;
                localStorage.setItem(cacheKey, JSON.stringify(timeSlots));
                cargarOpcionesHorarios();
            } catch (error) {
                console.error("Error al cargar los tramos horarios:", error);
                timeSlots = ["07:30 a 08:50", "09:00 a 10:20", "10:30 a 11:50", "12:00 a 13:20", "13:30 a 14:50"];
                cargarOpcionesHorarios();
            }
        }

        // Rellena el selector de horario din√°micamente
        function cargarOpcionesHorarios() {
            const selectHora = document.getElementById('hora');
            if (!selectHora) return;
            selectHora.innerHTML = '';
            timeSlots.forEach(timeslot => {
                if (timeslot !== "15:10 a 16:30" && timeslot !== "20:30 a 21:50") {
                    const option = document.createElement('option');
                    option.value = timeslot;
                    option.textContent = timeslot;
                    selectHora.appendChild(option);
                }
            });
        }

        // --- Obtiene el documento del usuario registrado con cach√© local para evitar lecturas repetidas ---
        // Cachea datos clave para sesi√≥n o navegaci√≥n continua.
        async function getUsuarioRegistradoDoc(uid) {
            const cacheKey = `usuarioDoc_${uid}`;
            const cacheData = localStorage.getItem(cacheKey);
            if (cacheData) {
                try {
                    const docData = JSON.parse(cacheData);
                    return { data: () => docData, exists: true };
                } catch {
                    localStorage.removeItem(cacheKey);
                }
            }
            const q = await db.collection("usuarios_registrados")
                .where("usuarioId", "==", uid)
                .get();
            if (!q.empty) {
                const doc = q.docs[0];
                localStorage.setItem(cacheKey, JSON.stringify(doc.data()));
                return doc;
            }
            return null;
        }        

        // Muestra cr√©ditos del usuario usando la cach√© anterior.
        async function mostrarCreditosUsuario() {
            const doc = await getUsuarioRegistradoDoc(usuarioActual.uid);
            if (!doc) {
                document.getElementById("creditosUsuario").textContent = "No disponible";
                return;
            }
            const datos = doc.data();
            const creditos = (datos.creditos != null) ? Number(datos.creditos) : 0;
            const nombre = capitalizarPrimeraLetra(datos.nombre || "");
            document.getElementById("creditosUsuario").textContent = `Clases para reservar de ${nombre}: ${creditos}`;
            if (!datos.info) popupInfo.style.display = 'flex';
        }

        // escucha los creditos del alumno recibiendo el nuevo creditos si se hubiera cambiado
        function escucharCreditosUsuario(uid) {
            console.log("Iniciando listener en docId:", docId);
            return db.collection('usuariosregistrados').where('usuarioId', '==', uid)
                .onSnapshot(snapshot => {
                    if (!snapshot.empty) {
                        console.log("Listener datos recibidos:", doc.data());
                        const doc = snapshot.docs[0];
                        const datos = doc.data();
                        const creditos = datos.creditos != null ? Number(datos.creditos) : 0;
                        console.log("Listener cr√©ditos recibido:", creditos);
                        document.getElementById('creditosUsuario').textContent = `Clases para reservar de ${datos.nombre}: ${creditos}`;
                        localStorage.setItem(`usuarioDoc_${uid}`, JSON.stringify(datos));
                    }
                }, error => {
                    console.error("Error listener cr√©ditos:", error);
                });
        }


        // --- Inicializa el calendario fullCalendar sin botones de mes para UI limpia ---
        function inicializarCalendario() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                alert("No se encontr√≥ el div con id 'calendar'");
                return;
            }
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                firstDay: 1,
                aspectRatio: 0.8,
                showNonCurrentDates: true,
                fixedWeekCount: false,
                expandRows: false,
                headerToolbar: {
                    left: '',
                    center: 'title',
                    right: ''
                },
                dayCellContent: function (info) {
                    const fechaLocal = new Date(info.date.getTime() - (info.date.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
                    const reservas = reservasTodas[fechaLocal] || { confirmadas: 0, pendientes: 0, examen: 0 };
                    let dotp = '', dotc = '', dote = '';
                    if (reservas.examen > 0) dote = `<span style="display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #ef63f8;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.examen}</span>`;
                    if (reservas.pendientes > 0) dotp = `<span style="display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #FF9800;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.pendientes}</span>`;
                    if (reservas.confirmadas > 0) dotc = `<span style="display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #4CAF50;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.confirmadas}</span>`;
                    return { html: info.dayNumberText + dote + dotp + dotc };
                },
                dateClick: info => cargarReservasDelDia(info.dateStr, "listado")
            });
            calendar.render();
        }     

        // --- Carga reservas para un d√≠a con cach√© dual (memoria + localStorage) para ahorro de lecturas ---
        async function cargarReservasDelDia(fechaStr, tipo) {
            if (tipo == "listado") {
                const lista = document.getElementById('lista-reservas-dia');
                lista.innerHTML = '<div class="cargando">Cargando...</div>';

                const cacheKey = `reservasDia_${fechaStr}`;
                const cacheTTL = 3600 * 1000; // 1 hora

                // Primero revisar cach√© localStorage con control de caducidad
                const cacheRaw = localStorage.getItem(cacheKey);
                if (cacheRaw) {
                    try {
                        const cacheObj = JSON.parse(cacheRaw);
                        if (Date.now() - cacheObj.timestamp < cacheTTL) {
                            mostrarReservasEnLista(cacheObj.data);
                            return;
                        } else {
                            localStorage.removeItem(cacheKey);
                        }
                    } catch {
                        localStorage.removeItem(cacheKey);
                    }
                }

                // No hay cach√© v√°lida, consulta Firebase
                try {
                    const tituloDia = document.getElementById('tituloReservasDia');
                    if (tituloDia) {
                        const fecha = new Date(fechaStr);
                        tituloDia.textContent = `Reservas del ${formatDateForDisplay(fecha)}`;
                    }
                    const fechaInicio = new Date(fechaStr + 'T00:00:00');
                    const fechaFin = new Date(fechaStr + 'T23:59:59');
                    const q = db.collection("reservas")
                        .where("fecha", ">=", fechaInicio)
                        .where("fecha", "<=", fechaFin)
                        .where('estado', 'in', ['confirmada', 'pendiente', 'examen']);
                    const querySnapshot = await q.get();

                    if (querySnapshot.empty) {
                        lista.innerHTML = '<div class="sin-reservas"><em>No hay reservas este d√≠a</em></div>';
                        localStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), data: [] }));
                        cacheReservasPorDia[fechaStr] = [];
                        return;
                    }

                    const reservas = [];
                    querySnapshot.forEach(doc => {
                        const r = doc.data();
                        if (typeof r.hora === 'string') reservas.push(r);
                    });

                    reservas.sort((a, b) => horaAminutos(a.hora) - horaAminutos(b.hora));
                    cacheReservasPorDia[fechaStr] = reservas;
                    localStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), data: reservas }));

                    mostrarReservasEnLista(reservas);
                } catch (error) {
                    console.error("Error:", error);
                    lista.innerHTML = '<div class="error">Error al cargar reservas</div>';
                }
            }
            if (tipo == "contar") {
                /*console.log("confirmadas antes: " + reservasTodas[fechaStr].confirmadas);
                console.log("pendientes antes: " + reservasTodas[fechaStr].pendientes);*/

                //reservasTodas[fechaStr].pendientes = conteos.pendientes;
                //reservasTodas[fechaStr].examen = conteos.examen;

                const fechaInicio = new Date(fechaStr + 'T00:00:00');
                const fechaFin = new Date(fechaStr + 'T23:59:59');
                const q = db.collection("reservas")
                    .where("fecha", ">=", fechaInicio)
                    .where("fecha", "<=", fechaFin)
                    .where('estado', 'in', ['confirmada', 'pendiente', 'examen']);

                const querySnapshot = await q.get();

                // Inicializa conteos
                const conteos = {
                    confirmadas: 0,
                    pendientes: 0,
                    examen: 0
                };

                if (!querySnapshot.empty) {
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        switch (data.estado) {
                            case 'confirmada':
                                conteos.confirmadas++;
                                break;
                            case 'pendiente':
                                conteos.pendientes++;
                                break;
                            case 'examen':
                                conteos.examen++;
                                break;
                        }
                    });
                }

                reservasTodas[fechaStr].confirmadas = conteos.confirmadas;
                reservasTodas[fechaStr].pendientes = conteos.pendientes;
                reservasTodas[fechaStr].examen = conteos.examen;

                if (calendar) calendar.render();

                /*console.log("confirmadas despues: " + reservasTodas[fechaStr].confirmadas);
                console.log("pendientes despues: " + reservasTodas[fechaStr].pendientes);*/
            }
        }

        // --- Muestra la lista de reservas del d√≠a en el DOM ---
        function mostrarReservasEnLista(reservas) {
            const lista = document.getElementById('lista-reservas-dia');
            lista.innerHTML = '';
            reservas.forEach(reserva => {
                const div = document.createElement('div');
                div.className = `reserva-dia-item ${reserva.estado}`;
                div.innerHTML = `
            <div class="reserva-hora">
              <span class="hora">${reserva.hora}</span>
              <span class="estado ${reserva.estado}">${reserva.estado}</span>
            </div>`;
                lista.appendChild(div);
            });
        }

        // --- Muestra s√≥lo reservas activas y futuras del usuario, filtrando y ordenando ---
        function mostrarReservasUsuario() {
            const lista = document.getElementById('lista-reservas');
            lista.innerHTML = "";
            if (reservasUsuario.length === 0) {
                lista.innerHTML = "<em>No tienes reservas a√∫n.</em>";
                return;
            }

            const hoyInicio = new Date();
            hoyInicio.setHours(0, 0, 0, 0);

            const reservasFiltradas = reservasUsuario.filter(r => {
                const fecha = new Date(r.fecha);
                return (r.estado === 'pendiente' || r.estado === 'confirmada') && (fecha >= hoyInicio);
            });

            if (reservasFiltradas.length === 0) {
                lista.innerHTML = "<em>No tienes reservas actuales o futuras.</em>";
                return;
            }

            reservasFiltradas.sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
                .forEach(r => {
                    const div = document.createElement('div');
                    div.className = `reserva-item ${r.estado}`;
                    const fechaTexto = new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
                    let contenidoHTML = '';

                    if (r.estado === 'pendiente') {
                        contenidoHTML = `
                <div class="reserva-item-compacta">
                    <span class="reserva-fecha">üìÖ ${fechaTexto}</span>
                    <span class="reserva-hora">‚è∞ ${r.hora}</span>
                    <button onclick="anularReserva('${r.fecha}', '${r.hora}', 'pendiente')" class="cta-btn-pendiente">pendiente</button>
                </div>`;
                    } else if (r.estado === 'confirmada') {
                        if (esMenosDe24Horas(r.fecha, r.hora)) {
                            contenidoHTML = `
                    <div class="reserva-item-compacta">
                        <span class="reserva-fecha">üìÖ ${fechaTexto}</span>
                        <span class="reserva-hora">‚è∞ ${r.hora}</span>
                        <button disabled class="cta-btn-confirmada-disabled" title="No se puede anular a menos de 24h o reservas pasadas">confirmada</button>
                    </div>`;
                        } else {
                            contenidoHTML = `
                    <div class="reserva-item-compacta">
                        <span class="reserva-fecha">üìÖ ${fechaTexto}</span>
                        <span class="reserva-hora">‚è∞ ${r.hora}</span>
                        <button onclick="anularReserva('${r.fecha}', '${r.hora}', 'confirmada')" class="cta-btn-confirmada">confirmada</button>
                    </div>`;
                        }
                    }

                    div.innerHTML = contenidoHTML;
                    lista.appendChild(div);
                });
        }

        // --- Funci√≥n para saber si faltan menos de 24h para anular ---
        function esMenosDe24Horas(fechaStr, horaStr) {
            const ahora = new Date();
            const [anio, mes, dia] = fechaStr.split('-').map(Number);
            const horaInicioStr = horaStr.split('a')[0].trim();
            const [h, m] = horaInicioStr.split(':').map(Number);
            const fechaHoraReserva = new Date(anio, mes - 1, dia, h, m);
            return ((fechaHoraReserva - ahora) / (1000 * 60 * 60)) < 24;
        }

        // ====================== FUNCI√ìN PRINCIPAL DE RESERVAS DEL CALENDARIO ======================
        // --- Carga reservas para el calendario y usuario, optimizando consultas ---
        async function cargarReservas() {
            if (!usuarioActual?.uid) {
                console.error("usuarioActual.uid no est√° definido.");
                return;
            }
            const ahora = new Date();
            const diaSemana = ahora.getDay();
            const distanciaALunes = (diaSemana + 6) % 7;
            const desde = new Date(ahora);
            desde.setDate(ahora.getDate() - distanciaALunes);
            desde.setHours(0, 0, 0, 0);
            const hasta = new Date(ahora);
            hasta.setDate(ahora.getDate() + 14);
            hasta.setHours(23, 59, 59, 999);

            // Consulta segmentada para evitar m√∫ltiples filtros IN (no permitidos)
            for (const estado of ['confirmada', 'pendiente', 'examen']) {
                const snapshot = await db.collection('reservas')
                    .where('fecha', '>=', firebase.firestore.Timestamp.fromDate(desde))
                    .where('fecha', '<=', firebase.firestore.Timestamp.fromDate(hasta))
                    .where('estado', '==', estado)
                    .get();

                snapshot.forEach(doc => {
                    const reserva = doc.data();
                    if (reserva.fecha?.toDate) {
                        const fechaDate = reserva.fecha.toDate();
                        const fechaStr = fechaDate.toLocaleDateString("es-ES", {
                            timeZone: "Europe/Madrid",
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit"
                        }).split("/").reverse().join("-");
                        if (!reservasTodas[fechaStr]) {
                            reservasTodas[fechaStr] = { confirmadas: 0, pendientes: 0, examen: 0, reservas: [] };
                        }
                        if (estado === 'examen') reservasTodas[fechaStr].examen++;
                        if (estado === 'confirmada') reservasTodas[fechaStr].confirmadas++;
                        if (estado === 'pendiente') reservasTodas[fechaStr].pendientes++;
                        reservasTodas[fechaStr].reservas.push(reserva);
                    }
                });
            }

            // Listener reactivo para reservas activas del usuario (futuras/presentes)
            const hoyInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            db.collection('reservas')
                .where('usuarioId', '==', usuarioActual.uid)
                .where('fecha', '>=', firebase.firestore.Timestamp.fromDate(hoyInicio))
                .where('estado', 'in', ['pendiente', 'confirmada'])
                .onSnapshot(snapshot => {
                    reservasUsuario = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.fecha?.toDate) {
                            const fechaLocal = d.fecha.toDate();
                            const fechaStr = fechaLocal.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }).split('/').reverse().join('-');
                            reservasUsuario.push({
                                ...d,
                                fecha: fechaStr,
                                id: doc.id
                            });
                        }
                    });
                    mostrarReservasUsuario();
                });

            if (calendar) calendar.refetchEvents();
            if (primeraCarga) {
                inicializarCalendario();
                primeraCarga = false;
            }
        }


        // --- Crear reservas con control de existencia previa ---
        // Cachea m√≠nimamente datos est√°ticos (usuario registrado), lee Firestore para reservas por fecha/hora por obligatoriedad de consistencia.
        async function crearReserva(e) {
            e.preventDefault();
            const reservaMsg = document.getElementById('reservaMsg');
            reservaMsg.textContent = "";
            const lista = document.getElementById('lista-reservas-dia');
            lista.innerHTML = '';
            const tituloDia = document.getElementById('tituloReservasDia');
            tituloDia.textContent = "Reservas del dia";
            const dia = document.getElementById('dia').value;
            const hora = document.getElementById('hora').value.trim();
                        
            const fechaDiaObj = new Date(dia);
            const esViernes = fechaDiaObj.getDay() === 5;
            const [horaSolicitada, minutosSolicitados] = hora.split(":").map(Number);
            if (esViernes && (horaSolicitada > 15 || (horaSolicitada === 15 && minutosSolicitados > 0))) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.innerHTML = "No est√° permitido reservar horas posteriores a las 15:00h los viernes. Selecciona otro horario.";
                return;
            }

            const bloque = document.getElementById('bloqueSemana').checked;
            let fechas = [dia];
            const usuarioDoc = await getUsuarioRegistradoDoc(usuarioActual.uid);
            if (!usuarioDoc || !usuarioDoc.exists) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.textContent = "Error: Usuario no encontrado";
                return;
            }
            const datos = usuarioDoc.data();
            const creditos = typeof datos.creditos === "number" ? datos.creditos : 0;

            if (bloque) {
                let fechaActual = new Date(dia);
                fechas = [];
                let diasLaborables = 0;
                while (diasLaborables < 5) {
                    fechaActual.setDate(fechaActual.getDate() + 1);
                    const diaSemana = fechaActual.getDay();
                    if (diaSemana !== 0 && diaSemana !== 6) {
                        fechas.push(toISODate(fechaActual));
                        diasLaborables++;
                    }
                }
            }

            const creditosNecesarios = fechas.length;
            const vacacionesprofe = await db.collection('usuarios_registrados')
                .where('perfil', '==', 'profesor')
                .get();
            const data = vacacionesprofe.docs[0].data();
            const inicioVac = data.fechainivacaciones?.toDate ? data.fechainivacaciones.toDate() : new Date(data.fechainivacaciones);
            const finVac = data.fechafinvacaciones?.toDate ? data.fechafinvacaciones.toDate() : new Date(data.fechafinvacaciones);
            const fechaDia = new Date(dia);
            if (fechaDia >= inicioVac && fechaDia <= finVac) {
                popupHolidays.style.display = 'flex';
                return;
            }

            if (creditos < creditosNecesarios) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.innerHTML = `No tienes clases suficientes para reservar.<br>Necesitas: ${creditosNecesarios} clases. Dispones: ${creditos} clases`;
                return;
            }

            const fechasFirestore = fechas.map(fecha => firebase.firestore.Timestamp.fromDate(new Date(fecha)));
            const existereservaSnap = await db.collection('reservas')
                .where('fecha', 'in', fechasFirestore)
                .where('hora', '==', hora)
                .get();
            const reservasFiltradas = existereservaSnap.docs.filter(doc => {
                const estado = doc.data().estado;
                return estado === 'confirmada' || estado === 'pendiente';
            });
            const hayConfirmada = reservasFiltradas.some(doc => doc.data().estado === 'confirmada');
            const hayPendienteUsuario = reservasFiltradas.some(doc => doc.data().estado === 'pendiente' && doc.data().usuarioId === usuarioActual.uid);
            if (hayConfirmada) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.innerHTML = `Ya existe una reserva confirmada para una de esas fechas a las ${hora}.<br>Por favor, selecciona otro tramo.`;
                return;
            }
            if (hayPendienteUsuario) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.innerHTML = `Ya tienes una reserva para el d√≠a seleccionado a esta hora.<br>No puedes reservar m√°s en la misma fecha y hora.`;
                return;
            }

            const batch = db.batch();
            const reservasImplicadas = [];
            for (const fecha of fechas) {
                if (!reservasTodas[fecha]) {
                    reservasTodas[fecha] = { confirmadas: 0, pendientes: 0, examen: 0, reservas: [] };
                }

                const reservaRef = db.collection('reservas').doc();

                batch.set(reservaRef, {
                    usuarioId: usuarioActual.uid,
                    usuarioNombre: datos.nombre || usuarioActual.email,
                    usuarioApellidos: datos.Apellidos || "",
                    fecha: firebase.firestore.Timestamp.fromDate(new Date(fecha)),
                    hora: hora,
                    estado: 'pendiente',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                reservasImplicadas.push({ id: reservaRef.id, fecha, hora });
                                
                const existe = reservasTodas[fecha].reservas.some(r =>
                    r.usuarioId === datos.usuarioId && r.fecha.seconds === firebase.firestore.Timestamp.fromDate(new Date(fecha)).seconds && r.hora === hora);
                if (!existe) {
                    reservasTodas[fecha].reservas.push({
                        usuarioId: datos.usuarioId,
                        usuarioNombre: datos.nombre || usuarioActual.email,
                        usuarioApellidos: datos.Apellidos || "",
                        fecha: firebase.firestore.Timestamp.fromDate(new Date(fecha)),
                        hora: hora,
                        estado: 'pendiente',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    cargarReservasDelDia(fecha, "contar");
                }               

            }

            batch.update(db.collection("usuarios_registrados").doc(usuarioActual.id), { creditos: creditos - creditosNecesarios });

            try {
                await batch.commit();
                console.log("Batch commit exitoso, reservas creadas.");                
                //if (calendar) calendar.render();
                //calendar.destroy();
                //inicializarCalendario();

            } catch (error) {
                console.error("Error al hacer commit del batch:", error);
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.textContent = "Error al crear las reservas, int√©ntalo m√°s tarde.";
                return;
            }

            fechas.forEach(fecha => localStorage.removeItem(`reservasDia_${fecha}`));
            localStorage.removeItem(`usuarioDoc_${usuarioActual.uid}`);

            await mostrarCreditosUsuario();
            //cargarReservas();

            await logCredito({
                usuarioId: datos.usuarioId,
                email: datos.email || usuarioActual.email,
                perfil: datos.perfil,
                creditosAntes: creditos,
                tipo: "restar",
                creditosDespues: creditos - creditosNecesarios,
                reservasImplicadas
            });

            reservaMsg.style.color = "#388e3c";
            reservaMsg.innerHTML = "Reserva(s) solicitada(s) correctamente.<br>RECUERDA: cuando se confirme, tienes hasta 24 horas antes para anularla.";
            document.getElementById('formReserva').reset();
        }



        // --- Funci√≥n para eliminar reservas y devolver cr√©ditos correctamente ---
        async function anularReserva(fechaStr, hora, estado) {
            try {
                const lista = document.getElementById('lista-reservas-dia');
                lista.innerHTML = '';
                const tituloDia = document.getElementById('tituloReservasDia');
                tituloDia.textContent = "Reservas del dia";

                const [anio, mes, dia] = fechaStr.split('-').map(Number);
                const inicioDia = firebase.firestore.Timestamp.fromDate(new Date(anio, mes - 1, dia, 0, 0, 0, 0));
                const finDia = firebase.firestore.Timestamp.fromDate(new Date(anio, mes - 1, dia, 23, 59, 59, 999));
                                
                const q = await db.collection("reservas")
                    .where("fecha", ">=", inicioDia)
                    .where("fecha", "<=", finDia)
                    .where("hora", "==", hora)
                    .where("estado", "==", estado)
                    .where("usuarioId", "==", usuarioActual.uid.trim())
                    .get();

                if (q.empty) {
                    reservaMsg.textContent = "No se encontr√≥ la reserva para anular.";
                    return;
                }

                /*const deletePromises = [];
                const reservasImplicadas = [];
                let reservasEliminadas = 0;

                q.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                    reservasEliminadas++;
                    const reserva = doc.data();
                    reservasImplicadas.push({
                        id: doc.id,
                        fecha: reserva.fecha.toDate().toISOString().split('T')[0],
                        hora: reserva.hora
                    });
                });

                await Promise.all(deletePromises);*/

                // Solo elimina la primera reserva encontrada (deber√≠a haber solo una)
                const doc = q.docs[0];
                await doc.ref.delete();

                const reserva = doc.data();
                const reservasImplicadas = [{
                    id: doc.id,
                    fecha: reserva.fecha.toDate().toISOString().split('T')[0],
                    hora: reserva.hora
                }];

                const userDocRef = db.collection("usuarios_registrados").doc(usuarioActual.id);
                const userDoc = await userDocRef.get();
                const datos = userDoc.data();
                const creditosActuales = datos?.creditos ?? 0;

                // Actualizar cr√©ditos y limpiar cach√© relacionada
                //await userDocRef.update({ creditos: creditosActuales + reservasEliminadas });
                await userDocRef.update({ creditos: creditosActuales + 1 });
                localStorage.removeItem(`usuarioDoc_${usuarioActual.uid}`);

                reservasImplicadas.forEach(r => localStorage.removeItem(`reservasDia_${r.fecha}`));

                await logCredito({
                    usuarioId: datos.usuarioId,
                    email: datos.email,
                    perfil: datos.perfil,
                    creditosAntes: creditosActuales,
                    tipo: "sumar",
                    //creditosDespues: creditosActuales + reservasEliminadas,
                    creditosDespues: creditosActuales + 1,
                    reservasImplicadas
                });
                
                reservaMsg.style.color = "#388e3c";
                //reservaMsg.innerHTML = `Reserva eliminada correctamente.<br>Se han sumado ${reservasEliminadas} clases a tus cr√©ditos.`;
                reservaMsg.innerHTML = `Reserva eliminada correctamente.<br>Se han sumado una clase a tus cr√©ditos.`;

                if (typeof mostrarCreditosUsuario === "function") mostrarCreditosUsuario();
                cargarReservasDelDia(fechaStr, "contar");

                //if (calendar) calendar.render();
                //calendar.destroy();
                //inicializarCalendario();
            } catch (error) {
                alert("Error al eliminar la reserva.");
                console.error("Error en anularReserva:", error);
            }
        }

        // --- Logueo de cambios en cr√©ditos ---

        async function logCredito({ usuarioId, email, perfil, creditosAntes, tipo, creditosDespues, reservasImplicadas }) {
            try {
                await db.collection("logcreditos").add({
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    usuarioId,
                    email,
                    perfil,
                    creditosAntes,
                    tipo,
                    creditosDespues,
                    reservasImplicadas
                });
            } catch (error) {
                console.error("Error al guardar el log de cr√©ditos:", error);
            }
        }

        
        const popupHolidays = document.getElementById('popupHolidays');
        const closeVacacionesBtn = document.querySelector('.closeHolidays');

        const infoVacaciones = `<h3>Durante este dia no impartir√© clases pr√°cticas por encontrarme de vacaciones</h3>`;

        const popupInfo = document.getElementById('popupInfo');
        const btnInfo = document.getElementById('btnInfo');
        const closeInfoBtn = document.querySelector('.closeInfo');

        const infoNormas = `<h3>Normas de las clases practicas</h3>
        <ul>
            <li><strong>No asistencia:</strong> Si por alguna circunstacia no pudieras asistir a una clase pr√°ctica, deber√°s avisar al profesor al menos con 24 horas de antelacion para que pueda cubrir ese hueco. Si no lo hicieras, tendri√°s que abonar la clase pr√°ctica y perder√≠as tu hora de clase.</li>
            <li><strong>Presentacion a exam√©n:</strong> Antes de ir al exam√©n pr√°ctico, debes dejarlo todo abonado.</li>
            <li><strong>Minimo de clases pr√°cticas:</strong> La autoescuela te obliga para a dar un minimo de 3 clases pr√°cticasde 80 minutos.</li>
            <li><strong>Horario de clases:</strong> La clase pr√°ctica comineza a la hora fijada y termina a la hora fijada. En caso de impuntualidad por parte del alumnado ser√° √©ste el que pierda minutos de clase.</li>
        </ul>
        `;

        const btnAyuda = document.getElementById('btnAyuda');
        const popupAyuda = document.getElementById('popupAyuda');
        const closeAyudaBtn = document.querySelector('.closeAyuda');

        const ayudaCalendario = `<h3>Uso de las reservas para las practicas</h3>
        <p>Aqu√≠ puedes ver todas las reservas solicitadas al profesor de practicas. Ver√°s el numero de clases que te quedan por realizar. Podr√°s solicitar practicas, anularlas y ver si el profesor las ha confirmado.</p>
        <ul>
            <li><strong>Calendario:</strong> Podr√°s ver todas las peticiones de reservas al profesor de practicas solicitadas por todos los alumnos, ya esten pendientes de confirmar por √©l, √≥ bien ya confirmadas.</li>
            <li><strong>Nueva solicitud de reserva:</strong> Podr√°s solicitar una reserva, eligiendo el dia y hora. Si chequeas la opcion de "Reservar este horario para 5 dias seguidos" se haran reserva de 5 dias a partir del dia elegido y a la misma hora.</li>
            <li><strong>Mis solicitudes de reserva:</strong> Visualizar√°s un listado con s√≥lo tus solicitudes de reservas de pr√°cticas. En el listado podr√°s anular las solicitudes, ya est√©n en el estado de "pendientes" √≥ "confirmadas" en el propio boton donde se indica su estado. Pero ten en cuenta que las confirmadas tienen un l√≠mite para su anulaci√≥n de hasta 24 horas antes del dia y hora de las reserva.</li>
            <li><strong>Reservas del d√≠a:</strong> Si haces clic en una fecha del calendario, visualizaras en este apartado todas las reservas solicitadas por todos los alumnos para ese dia tanto si est√°n pendientes como confirmadas.</li>
        </ul>
        `;

        closeVacacionesBtn.addEventListener('click', () => {
            popupHolidays.style.display = 'none';
        });

        btnAyuda.addEventListener('click', () => {
            popupAyuda.style.display = 'flex';
        });

        closeAyudaBtn.addEventListener('click', () => {
            popupAyuda.style.display = 'none';
        });

        btnInfo.addEventListener('click', () => {
            db.collection("usuarios_registrados").doc(usuarioActual.id).update({ info: true });
            popupInfo.style.display = 'none';
        });

        closeInfoBtn.addEventListener('click', () => {
            popupInfo.style.display = 'none';
        });

        popupAyuda.addEventListener('click', (e) => {
            if (e.target === popupAyuda) {
                popupAyuda.style.display = 'none';
            }
        });
    </script>

</body>
</html>
