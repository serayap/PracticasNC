<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Distribuci√≥n Formulario + Calendario + Listado</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="calendario.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        let usuarioActual = {};
       
        function actualizarUI() {
            document.getElementById('tituloReservas').textContent = `Reservas de pr√°cticas con Carlos`;

            mostrarCreditosUsuario();
            cargarTimeSlots();
            cargarDias();
            cargarReservas();

            document.getElementById('formReserva').addEventListener('submit', crearReserva);
            document.getElementById('contenidoAyuda').innerHTML = ayudaCalendario;
            document.getElementById('contenidoInfo').innerHTML = infoNormas;
            document.getElementById('contenidoHolidays').innerHTML = infoVacaciones;
        }

        function dct(e) {
            const bytes = CryptoJS.AES.decrypt(e, "34#-2?579/fbh%$l(O√±h05t@");
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        }
        const firebaseConfig = dct("U2FsdGVkX1/wVoGGAPam24EP2C4b4c5OTPYzVoVmcY3hFxXHl+PfMkhFPUbKc8cRmwTvM44kMrg2sXgyT1mMB5/t3bUiIjIQDe1suqcD2SMvW7RVdJ1jCasaAMGo7a529bxkmCH6zKx+5iysRXw5PIzCKpUh1IGyItrCekPNJjt6zk4g8tP3qDNZizE4u62WVlvG4tp68iHasgwgYWkgzHhuN5/aYc4cRumfEDLPzz1Yf0EbSk3QM5QeGQDGficRCyNbgyaFbqj83wnjHWX4kZQ2iKddEdtNUqqjYHe0Mc0n5YI31rLP5o9dtAONCrrFRadsW0bfVC1ZCQWm5/JoLsi/6Xgxv0Oy3f7b8ncnNbCtsiYZhkgsPn7v2TU+CH/LBm5rUeVTji6lKNh2CYHs+A==");

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        // Inicializa Firestore si no lo has hecho
        const db = firebase.firestore();

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            
            try {
                const q = await db.collection('usuarios_registrados')
                    .where('usuarioId', '==', user.uid)
                    .get();
                if (!q.empty) {
                    usuarioActual.id = q.docs[0].id;
                    usuarioActual.nombre = q.docs[0].data().nombre;
                    usuarioActual.email = q.docs[0].data().email;
                    usuarioActual.perfil = q.docs[0].data().perfil;
                    usuarioActual.uid = user.uid;
                    //usuarioActual.uid = ""; //prueba con otro uid
                    usuarioActual.info = q.docs[0].data().info;
                    //console.log(usuarioActual.uid);

                    // Control de acceso por perfil
                    if (usuarioActual.perfil !== "alumno") {
                        window.location.href = "index.html";
                        return;
                    }

                    document.body.classList.remove("oculto");

                    if (document.readyState === 'loading') {                        
                        document.addEventListener('DOMContentLoaded', actualizarUI);
                    } else {
                        actualizarUI();
                    }
                } else {
                    console.warn("No existe documento para ese usuarioId en usuarios_registrados");
                    window.location.href = "index.html";
                }
            } catch (err) {
                console.error("Error buscando documento de usuario registrado:", err);
                window.location.href = "index.html";
            }
        });

    </script>

</head>
<body class="oculto">
    <div class="container">
        <h2 class="cabecera-principal" id="tituloReservas"></h2>
        <div id="subcabecera-creditos" class="subcabecera-creditos">
            <span id="creditosUsuario">...</span>
        </div>
        <div class="arriba">
            <div>
                <div class="form-reserva">
                    <h2 class="cabecera">Nueva solicitud de reserva</h2>
                    <form id="formReserva">
                        <div class="form-row">
                            <label for="dia">D√≠a:</label>
                            <select id="dia" required></select>
                            <label for="hora">Hora:</label>
                            <select id="hora" required></select>
                        </div>
                        <!--<div class="form-row">
                            <label for="hora">Hora:</label>
                            <select id="hora" required></select>
                        </div>-->
                        <div class="form-row">
                            <input type="checkbox" id="bloqueSemana" class="block-week">
                            <label for="bloqueSemana">Reservar este horario para 5 dias seguidos</label>
                        </div>
                        <button type="submit" class="cta-btn-solicitar">Solicitar reserva</button>
                        <div id="addreservaMsg"></div>
                    </form>
                </div>
                <div class="form-reserva">
                    <h2 class="cabecera">Mis solicitudes de reservas</h2>
                    <!-- Aqu√≠ tu listado -->
                    <div id="lista-reservas"></div>
                    <div id="reservaMsg"></div>
                </div>
            </div>
            <div id="calendar-container">
                <div id="calendar"></div>
                <!-- Leyenda de colores -->
                <div class="leyenda-colores">
                    <span class="leyenda-item"><span class="dot dot-pendiente"></span>Pendiente</span>
                    <span class="leyenda-item"><span class="dot dot-confirmada"></span>Confirmada</span>
                    <span class="leyenda-item"><span class="dot dot-examen"></span>Examen</span>
                </div>
                <div class="seccion-derecha">
                    <div class="reservas-dia">
                        <h2 class="cabecera" id="tituloReservasDia">Reservas del d√≠a</h2>
                        <div id="lista-reservas-dia"></div>
                    </div>
                    <button id="btnAyuda" class="btn-ayuda">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
                <!--<div class="seccion-derecha">
                        <div class="reservas-dia">
                            <h2 class="cabecera" id="tituloReservasDia">Reservas del d√≠a</h2>
                            <div id="lista-reservas-dia"></div>
                        </div>
                    </div>-->
            </div>
        </div>
    </div>
    <div id="popupInfo" class="popup">
        <div class="popup-content">
            <span class="closeInfo">&times;</span>
            <h2>Normas de las clases Practicas</h2>
            <div id="contenidoInfo">
                <!-- Aqu√≠ va el contenido de ayuda espec√≠fico para cada p√°gina -->
            </div>
            <button class="btnInfo" id="btnInfo">Entendido</button>
        </div>
    </div>
    <div id="popupHolidays" class="popup">
        <div class="popup-content">
            <span class="closeHolidays">&times;</span>
            <h2>Cierre de las clases Practicas por vacaciones</h2>
            <div id="contenidoHolidays">
                <!-- Aqu√≠ va el contenido de ayuda espec√≠fico para cada p√°gina -->
            </div>
        </div>
    </div>
    <div id="popupAyuda" class="popup">
        <div class="popup-content">
            <span class="closeAyuda">&times;</span>
            <h2>Ayuda</h2>
            <div id="contenidoAyuda">
                <!-- Aqu√≠ va el contenido de ayuda espec√≠fico para cada p√°gina -->
            </div>
        </div>
    </div>
    <script>
        const settings = { experimentalForceLongPolling: true, merge: true };
        db.settings(settings);

        let calendar = null;
        let primeraCarga = true;
        let reservasTodas = {};
        let reservasUsuario = [];
        let cacheReservasPorDia = {}; // Cach√© local para evitar consultas repetidas

        async function getUsuarioRegistradoDoc(uid) {
            const q = await db.collection("usuarios_registrados")
                .where("usuarioId", "==", uid)
                .get();
            if (!q.empty) {
                return q.docs[0]; // Devuelve el DocumentSnapshot
            }
            return null;
        }

        async function mostrarCreditosUsuario() {
            const doc = await getUsuarioRegistradoDoc(usuarioActual.uid);
            if (!doc) {
                document.getElementById("creditosUsuario").textContent = "No disponible";
                return;
            }
            const datos = doc.data();
            const creditos = datos.creditos !== undefined && datos.creditos !== null ? Number(datos.creditos) : 0;
            const nombre = capitalizarPrimeraLetra(datos.nombre || "");
            document.getElementById("creditosUsuario").textContent = "Clases para reservar de " + nombre + ": " + creditos;

            if (!datos.info) popupInfo.style.display = 'flex';
        }

        function capitalizarPrimeraLetra(str) {
            return str.replace(/\b\w/g, function (char) {
                return char.toUpperCase();
            });
        }

        function toISODate(date) {
            return date.toISOString().split('T')[0];
        }

        function cargarDias() {
            const selectDia = document.getElementById('dia');
            selectDia.innerHTML = "";
            const hoy = new Date();
            for (let i = 1; i < 15; i++) {
                const fecha = new Date(hoy);
                fecha.setDate(hoy.getDate() + i);
                const diaSemana = fecha.getDay();
                if (diaSemana !== 0 && diaSemana !== 6) {
                    const fechaISO = toISODate(fecha);
                    const texto = formatDateForDisplay(fecha);
                    const option = document.createElement('option');
                    option.value = fechaISO;
                    option.textContent = texto.charAt(0).toUpperCase() + texto.slice(1);
                    selectDia.appendChild(option);
                }
            }
        }

        async function cargarTimeSlots() {
            const cacheKey = "timeSlotsCache";
            const cacheData = localStorage.getItem(cacheKey);
            if (cacheData) {
                try {
                    timeSlots = JSON.parse(cacheData);
                    cargarOpcionesHorarios();
                    return;
                } catch { }
            }

            try {
                const h = await db.collection("configuracion").doc("horarios").get();
                timeSlots = h.data().slots;
                localStorage.setItem(cacheKey, JSON.stringify(timeSlots));
            } catch (error) {
                console.error("Error al cargar los tramos horarios:", error);
                timeSlots = ["07:30 a 08:50", "09:00 a 10:20", "10:30 a 11:50", "12:00 a 13:20", "13:30 a 14:50"];
            }
            cargarOpcionesHorarios();
        }

        function cargarOpcionesHorarios() {
            const selectHora = document.getElementById('hora');
            if (!selectHora) return;
            selectHora.innerHTML = '';
            timeSlots.forEach(timeslot => {
                if (timeslot != "15:10 a 16:30" && timeslot != "20:30 a 21:50") {
                    const option = document.createElement('option');
                    option.value = timeslot;
                    option.textContent = timeslot;
                    selectHora.appendChild(option);
                }
            });
        }

        function inicializarCalendario() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                alert("No se encontr√≥ el div con id 'calendar'");
                return;
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                firstDay: 1,
                aspectRatio: 0.8,
                showNonCurrentDates: true,
                fixedWeekCount: false,
                expandRows: false,
                headerToolbar: {
                    left: '',      // No mostrar bot√≥n previo
                    center: 'title',  // Mostrar solo el t√≠tulo del mes
                    right: ''      // No mostrar bot√≥n siguiente
                },
                dayCellContent: function (info) {
                    // Corregir fecha para zona horaria local
                    const fechaLocal = new Date(info.date.getTime() - (info.date.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
                    const reservas = reservasTodas[fechaLocal] || { confirmadas: 0, pendientes: 0, examen: 0 };
                    let dotp = '', dotc = '', dote = '';
                    if (reservas.examen > 0) {
                        dote = `<span style="display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #ef63f8;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.examen}</span>`;
                    }
                    if (reservas.pendientes > 0) {
                        dotp = `<span style="display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #FF9800;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.pendientes}</span>`;
                    }
                    if (reservas.confirmadas > 0) {
                        dotc = `<span style="display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #4CAF50;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.confirmadas}</span>`;
                    }
                    return { html: info.dayNumberText + dote + dotp + dotc };
                },
                dateClick: function (info) {
                    cargarReservasDelDia(info.dateStr);
                }
            });
            calendar.render();
        }


        async function cargarReservasDelDia(fechaStr) {
            const lista = document.getElementById('lista-reservas-dia');
            lista.innerHTML = '<div class="cargando">Cargando...</div>';

            if (cacheReservasPorDia[fechaStr]) {
                mostrarReservasEnLista(cacheReservasPorDia[fechaStr]);
                return;
            }

            try {
                const tituloDia = document.getElementById('tituloReservasDia');
                if (tituloDia) {
                    const fecha = new Date(fechaStr);
                    tituloDia.textContent = `Reservas del ${fecha.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long'
                    })}`;
                }

                const fechaInicio = new Date(fechaStr + 'T00:00:00');
                const fechaFin = new Date(fechaStr + 'T23:59:59');

                const q = db.collection("reservas")
                    .where("fecha", ">=", fechaInicio)
                    .where("fecha", "<=", fechaFin)
                    .where('estado', 'in', ['confirmada', 'pendiente', 'examen']);

                const querySnapshot = await q.get();

                if (querySnapshot.empty) {
                    lista.innerHTML = '<div class="sin-reservas"><em>No hay reservas este d√≠a</em></div>';
                    cacheReservasPorDia[fechaStr] = [];
                    return;
                }

                const reservas = [];
                querySnapshot.forEach(doc => {
                    const reserva = doc.data();
                    if (reserva.hora && typeof reserva.hora === 'string') {
                        reservas.push(reserva);
                    }
                });

                reservas.sort((a, b) => horaAminutos(a.hora) - horaAminutos(b.hora));

                cacheReservasPorDia[fechaStr] = reservas;

                mostrarReservasEnLista(reservas);

            } catch (error) {
                console.error("Error:", error);
                lista.innerHTML = '<div class="error">Error al cargar reservas</div>';
            }
        }

        function mostrarReservasEnLista(reservas) {
            const lista = document.getElementById('lista-reservas-dia');
            lista.innerHTML = '';
            reservas.forEach(reserva => {
                const div = document.createElement('div');
                div.className = `reserva-dia-item ${reserva.estado}`;
                div.innerHTML = `
                    <div class="reserva-hora">
                      <span class="hora">${reserva.hora}</span>
                      <span class="estado ${reserva.estado}">${reserva.estado}</span>
                    </div>`;
                lista.appendChild(div);
            });
        }

        function horaAminutos(horaRango) {
            try {
                const [inicio] = horaRango.split(' a ');
                const [hora, minutos] = inicio.split(':').map(Number);
                return hora * 60 + minutos;
            } catch (error) {
                console.error("Error al parsear la hora:", horaRango);
                return 0;
            }
        }

        function mostrarReservasUsuario() {
            const lista = document.getElementById('lista-reservas');
            lista.innerHTML = "";

            if (reservasUsuario.length === 0) {
                lista.innerHTML = "<em>No tienes reservas a√∫n.</em>";
                return;
            }

            const hoy = new Date();
            const hoyInicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()).getTime();

            // Filtrar solo reservas con fecha >= hoy
            const reservasFiltradas = reservasUsuario.filter(r => {
                const reservaFecha = new Date(r.fecha).getTime();
                return reservaFecha >= hoyInicio;
            });

            if (reservasFiltradas.length === 0) {
                lista.innerHTML = "<em>No tienes reservas actuales o futuras.</em>";
                return;
            }

            reservasFiltradas
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
                .forEach(r => {
                    const div = document.createElement('div');
                    div.className = `reserva-item ${r.estado}`;

                    const fechaTexto = new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });

                    let contenidoHTML = '';

                    if (r.estado === 'pendiente') {
                        contenidoHTML = `
                    <div class="reserva-item-compacta">
                        <span class="reserva-fecha">üìÖ ${fechaTexto}</span>
                        <span class="reserva-hora">‚è∞ ${r.hora}</span>
                        <button onclick="anularReserva('${r.fecha}', '${r.hora}', 'pendiente')" class="cta-btn-pendiente">anular</button>
                    </div>`;
                    } else if (r.estado === 'confirmada') {
                        if (esMenosDe24Horas(r.fecha, r.hora)) {
                            contenidoHTML = `
                        <div class="reserva-item-compacta">
                            <span class="reserva-fecha">üìÖ ${fechaTexto}</span>
                            <span class="reserva-hora">‚è∞ ${r.hora}</span>
                            <button disabled class="cta-btn-confirmada-disabled" title="No se puede anular a menos de 24h o reservas pasadas">confirmada</button>
                        </div>`;
                        } else {
                            contenidoHTML = `
                        <div class="reserva-item-compacta">
                            <span class="reserva-fecha">üìÖ ${fechaTexto}</span>
                            <span class="reserva-hora">‚è∞ ${r.hora}</span>
                            <button onclick="anularReserva('${r.fecha}', '${r.hora}', 'confirmada')" class="cta-btn-confirmada">confirmada</button>
                        </div>`;
                        }
                    } /*else if (r.estado === 'anulada') {
                        contenidoHTML = `
                    <div class="reserva-item-compacta">
                        <span class="reserva-fecha">üìÖ ${fechaTexto}</span>
                        <span class="reserva-hora">‚è∞ ${r.hora}</span>
                        <div class="cta-btn" style="background: linear-gradient(90deg, #ff6a6a 30%, #ffe0e0 100%)">anulada</div>
                    </div>`;
                    }*/

                    div.innerHTML = contenidoHTML;
                    lista.appendChild(div);
                });
        }

        // Funci√≥n para saber si faltan menos de 24h para la reserva
        function esMenosDe24Horas(fechaStr, horaStr) {
            // fechaStr: 'YYYY-MM-DD', horaStr: 'HH:MM a HH:MM'
            const ahora = new Date();
            const [anio, mes, dia] = fechaStr.split('-').map(Number);
            const horaInicioStr = horaStr.split('a')[0].trim(); // "HH:MM"
            const [h, m] = horaInicioStr.split(':').map(Number);
            const fechaHoraReserva = new Date(anio, mes - 1, dia, h, m, 0, 0);
            const diferenciaMs = fechaHoraReserva - ahora;
            const horasRestantes = diferenciaMs / (1000 * 60 * 60);
            return horasRestantes < 24;
        }

        async function cargarReservas() {
            if (!usuarioActual?.uid) {
                console.error("usuarioActual.uid no est√° definido. No se puede cargar reservas del usuario.");
                return;
            }

            const ahora = new Date();
            /*const desde = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
            const hasta = new Date();
            hasta.setDate(ahora.getDate() + 30);*/

            // Calcular lunes de esta semana (primer d√≠a)
            const diaSemana = ahora.getDay(); // 0=domingo, 1=lunes,...6=s√°bado
            const distanciaALunes = (diaSemana + 6) % 7; // lunes como inicio semana (0 si hoy es lunes)
            const desde = new Date(ahora);
            desde.setDate(ahora.getDate() - distanciaALunes);
            desde.setHours(0, 0, 0, 0); // inicio del d√≠a

            // Fecha final 2 semanas despu√©s de hoy
            const hasta = new Date(ahora);
            hasta.setDate(ahora.getDate() + 14);
            hasta.setHours(23, 59, 59, 999);

            db.collection('reservas')
                .where('fecha', '>=', firebase.firestore.Timestamp.fromDate(desde))
                .where('fecha', '<=', firebase.firestore.Timestamp.fromDate(hasta))
                .onSnapshot(snapshot => {
                    reservasTodas = {};
                    snapshot.forEach(doc => {
                        const reserva = doc.data();
                        if (reserva.fecha?.toDate) {
                            const fechaDate = reserva.fecha.toDate();
                            const fechaStr = fechaDate.toLocaleDateString("es-ES", {
                                timeZone: "Europe/Madrid",
                                year: "numeric",
                                month: "2-digit",
                                day: "2-digit"
                            }).split("/").reverse().join("-");
                            if (!reservasTodas[fechaStr]) {
                                reservasTodas[fechaStr] = { confirmadas: 0, pendientes: 0, examen: 0, reservas: [] };
                            }
                            if (reserva.estado === 'examen') reservasTodas[fechaStr].examen++;
                            if (reserva.estado === 'confirmada') reservasTodas[fechaStr].confirmadas++;
                            if (reserva.estado === 'pendiente') reservasTodas[fechaStr].pendientes++;
                            reservasTodas[fechaStr].reservas.push(reserva);
                        }
                    });
                    if (calendar) calendar.refetchEvents();
                    if (primeraCarga) {
                        inicializarCalendario();
                        primeraCarga = false;
                    }
                });

            db.collection('reservas')
                .where('usuarioId', '==', usuarioActual.uid)
                .onSnapshot(snapshot => {
                    reservasUsuario = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.fecha?.toDate) {
                            const fechaLocal = d.fecha.toDate();
                            const fechaStr = fechaLocal.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }).split('/').reverse().join('-');
                            reservasUsuario.push({
                                ...d,
                                fecha: fechaStr,
                                id: doc.id
                            });
                        }
                    });
                    mostrarReservasUsuario();
                });
        }

        async function crearReserva(e) {
            e.preventDefault();
            const reservaMsg = document.getElementById('reservaMsg');
            reservaMsg.textContent = "";
            const lista = document.getElementById('lista-reservas-dia');
            lista.innerHTML = '';
            const tituloDia = document.getElementById('tituloReservasDia');
            tituloDia.textContent = "Reservas del dia";

            const dia = document.getElementById('dia').value;
            const hora = document.getElementById('hora').value.trim();

            // --- Restricci√≥n tardes de viernes ---
            const fechaDiaObj = new Date(dia);
            const esViernes = fechaDiaObj.getDay() === 5; // viernes = 5
            // Hora en formato "hh:mm", por ejemplo "16:30"
            const [horaSolicitada, minutosSolicitados] = hora.split(":").map(Number);

            if (esViernes && (horaSolicitada > 15 || (horaSolicitada === 15 && minutosSolicitados > 0))) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.innerHTML = "No est√° permitido reservar horas posteriores a las 15:00h los viernes. Selecciona otro horario.";
                return;
            }

            const bloque = document.getElementById('bloqueSemana').checked;
            let fechas = [dia];

            const usuarioDoc = await getUsuarioRegistradoDoc(usuarioActual.uid);
            if (!usuarioDoc || !usuarioDoc.exists) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.textContent = "Error: Usuario no encontrado";
                return;
            }
            const datos = usuarioDoc.data();
            const creditos = typeof datos.creditos === "number" ? datos.creditos : 0;

            if (bloque) {
                let fechaActual = new Date(dia);
                fechas = [];
                let diasLaborables = 0;
                while (diasLaborables < 5) {
                    fechaActual.setDate(fechaActual.getDate() + 1);
                    const diaSemana = fechaActual.getDay();
                    if (diaSemana !== 0 && diaSemana !== 6) {
                        fechas.push(toISODate(fechaActual));
                        diasLaborables++;
                    }
                }
            }
            const creditosNecesarios = fechas.length;

            const vacacionesprofe = await db.collection('usuarios_registrados')
                .where('perfil', '==', 'profesor')
                .get();
            const data = vacacionesprofe.docs[0].data();
            const inicioVac = data.fechainivacaciones?.toDate ? data.fechainivacaciones.toDate() : new Date(data.fechainivacaciones);
            const finVac = data.fechafinvacaciones?.toDate ? data.fechafinvacaciones.toDate() : new Date(data.fechafinvacaciones);
            const fechaDia = new Date(dia);
            if (fechaDia >= inicioVac && fechaDia <= finVac) {
                popupHolidays.style.display = 'flex';
                return;
            }

            // 4. Verificar cr√©ditos
            if (creditos < creditosNecesarios) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.innerHTML = `No tienes clases suficientes para reservar.<br>Necesitas: ${creditosNecesarios} clases. Dispones: ${creditos} clases`;
                return;
            }

            // 5.1. Verificar reserva existente del usuario
            const fechasFirestore = fechas.map(fecha => firebase.firestore.Timestamp.fromDate(new Date(fecha)));
            const reservasExistentesSnap = await db.collection('reservas')
                .where('usuarioId', '==', usuarioActual.uid)
                .where('fecha', '==', fechasFirestore)
                .where('hora', '==', hora)
                .where('estado', 'in', ['confirmada', 'pendiente'])
                .get();

            for (const fecha of fechasFirestore) {
                const reservaExiste = reservasExistentesSnap.docs.some(doc => {
                    const data = doc.data();
                    return data.fecha.toMillis() === fecha.toMillis() && data.usuarioId === usuarioActual.uid;
                });
                if (reservaExiste) {
                    reservaMsg.style.color = "#d32f2f";
                    reservaMsg.innerHTML = `Ya tienes una reserva para el d√≠a seleccionado a esta hora.<br>No puedes reservar m√°s en la misma fecha y hora.`;
                    return;
                }
            }

            // 5.2. Verificar reserva confirmada de otro usuario
            const reservasConfirmadasSnap = await db.collection('reservas')
                .where('fecha', 'in', fechasFirestore)
                .where('hora', '==', hora)
                .where('estado', '==', 'confirmada')
                .get();

            const otraReserva = reservasConfirmadasSnap.docs.find(doc => doc.data().usuarioId !== usuarioActual.uid);
            if (otraReserva) {
                reservaMsg.style.color = "#d32f2f";
                reservaMsg.innerHTML = `Ya existe una reserva confirmada para una de esas fechas a las ${hora}.<br>Por favor, selecciona otro tramo.`;
                return;
            }

            // 6. Crear reservas
            const reservasImplicadas = [];
            const batch = db.batch();

            for (const fecha of fechas) {
                const reservaRef = db.collection('reservas').doc();
                batch.set(reservaRef, {
                    usuarioId: usuarioActual.uid,
                    usuarioNombre: datos.nombre || usuarioActual.email,
                    usuarioApellidos: datos.Apellidos,
                    fecha: firebase.firestore.Timestamp.fromDate(new Date(fecha)),
                    hora: hora,
                    estado: 'pendiente',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                reservasImplicadas.push({
                    id: reservaRef.id,
                    fecha: fecha,
                    hora: hora
                });
            }

            // 7. Actualizar cr√©ditos
            const nuevosCreditos = creditos - creditosNecesarios;
            batch.update(db.collection("usuarios_registrados").doc(usuarioDoc.id), {
                creditos: nuevosCreditos
            });

            // Ejecutar batch
            await batch.commit();

            // 8. Actualizar UI
            if (typeof mostrarCreditosUsuario === "function") {
                mostrarCreditosUsuario();
            }

            // 9. Registrar en log
            await logCredito({
                usuarioId: datos.usuarioId,
                email: datos.email || usuarioActual.email,
                perfil: datos.perfil,
                creditosAntes: creditos,
                tipo: "restar",
                creditosDespues: nuevosCreditos,
                reservasImplicadas: reservasImplicadas
            });

            // 10. Mensaje de √©xito
            reservaMsg.style.color = "#388e3c";
            reservaMsg.innerHTML = "Reserva(s) solicitada(s) correctamente.<br>RECUERDA: cuando se confirme, tienes hasta 24 horas antes para anularla.";
            document.getElementById('formReserva').reset();

            // 11. Actualizar calendario si es necesario
            if (typeof calendar !== 'undefined' && typeof calendar.render === 'function') {
                calendar.render();
            }
        }

        function formatDateForDisplay(date) {
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'short'
            });
        }

        async function anularReserva(fechaStr, hora, estado) {
            try {
                const lista = document.getElementById('lista-reservas-dia');
                lista.innerHTML = '';
                const tituloDia = document.getElementById('tituloReservasDia');
                tituloDia.textContent = "Reservas del dia";

                const [anio, mes, dia] = fechaStr.split('-').map(Number);
                const inicioDia = firebase.firestore.Timestamp.fromDate(new Date(anio, mes - 1, dia, 0, 0, 0, 0));
                const finDia = firebase.firestore.Timestamp.fromDate(new Date(anio, mes - 1, dia, 23, 59, 59, 999));

                const q = await db.collection("reservas")
                    .where("fecha", ">=", inicioDia)
                    .where("fecha", "<=", finDia)
                    .where("hora", "==", hora)
                    .where("estado", "==", estado)
                    .where("usuarioId", "==", usuarioActual.uid.trim())
                    .get();

                if (q.empty) {
                    reservaMsg.textContent = "No se encontr√≥ la reserva para anular.";
                    return;
                }

                //let reservasAnuladas = 0;
                //const updatePromises = [];
                let reservasEliminadas = 0;
                const deletePromises = [];
                const reservasImplicadas = [];


                q.forEach((doc) => {
                    //updatePromises.push(doc.ref.update({ estado: "anulada" }));
                    deletePromises.push(doc.ref.delete());
                    //reservasAnuladas++;
                    reservasEliminadas++;

                    const reserva = doc.data();
                    reservasImplicadas.push({
                        id: doc.id,
                        fecha: reserva.fecha.toDate().toISOString().split('T')[0],
                        hora: reserva.hora
                    });
                });
                //await Promise.all(updatePromises);
                await Promise.all(deletePromises);

                //const clasesASumar = reservasAnuladas;
                const clasesASumar = reservasEliminadas;

                const userDocRef = db.collection("usuarios_registrados").doc(usuarioActual.id);
                const userDoc = await userDocRef.get();
                const datos = userDoc.data();
                const creditosActuales = datos && typeof datos.creditos === "number" ? datos.creditos : 0;

                await userDocRef.update({
                    creditos: creditosActuales + clasesASumar
                });

                await logCredito({
                    usuarioId: datos.usuarioId,
                    email: datos.email,
                    perfil: datos.perfil,
                    creditosAntes: creditosActuales,
                    tipo: "sumar",
                    creditosDespues: creditosActuales + clasesASumar,
                    reservasImplicadas: reservasImplicadas
                });

                if (typeof mostrarCreditosUsuario === "function") {
                    mostrarCreditosUsuario();
                }

                reservaMsg.style.color = "#388e3c";
                reservaMsg.innerHTML = `Reserva eliminada correctamente.<br>Se han sumado ${clasesASumar} clases a tus cr√©ditos.`;
                calendar.render();
            } catch (error) {
                alert("Error al eliminar la reserva.");
            }
        }

        async function logCredito({
            usuarioId,
            email,
            perfil,
            creditosAntes,
            tipo,
            creditosDespues,
            reservasImplicadas
        }) {
            try {
                await db.collection("logcreditos").add({
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    usuarioId,
                    email,
                    perfil,
                    creditosAntes,
                    tipo,
                    creditosDespues,
                    reservasImplicadas
                });
            } catch (error) {
                console.error("Error al guardar el log de cr√©ditos:", error);
            }
        }

        const popupHolidays = document.getElementById('popupHolidays');
        const closeVacacionesBtn = document.querySelector('.closeHolidays');

        const infoVacaciones = `<h3>Durante este dia no impartir√© clases pr√°cticas por encontrarme de vacaciones</h3>`;

        const popupInfo = document.getElementById('popupInfo');
        const btnInfo = document.getElementById('btnInfo');
        const closeInfoBtn = document.querySelector('.closeInfo');

        const infoNormas = `<h3>Normas de las clases practicas</h3>
        <ul>
            <li><strong>No asistencia:</strong> Si por alguna circunstacia no pudieras asistir a una clase pr√°ctica, deber√°s avisar al profesor al menos con 24 horas de antelacion para que pueda cubrir ese hueco. Si no lo hicieras, tendri√°s que abonar la clase pr√°ctica y perder√≠as tu hora de clase.</li>
            <li><strong>Presentacion a exam√©n:</strong> Antes de ir al exam√©n pr√°ctico, debes dejarlo todo abonado.</li>
            <li><strong>Minimo de clases pr√°cticas:</strong> La autoescuela te obliga para a dar un minimo de 3 clases pr√°cticasde 80 minutos.</li>
            <li><strong>Horario de clases:</strong> La clase pr√°ctica comineza a la hora fijada y termina a la hora fijada. En caso de impuntualidad por parte del alumnado ser√° √©ste el que pierda minutos de clase.</li>
        </ul>
        `;

        const btnAyuda = document.getElementById('btnAyuda');
        const popupAyuda = document.getElementById('popupAyuda');
        const closeAyudaBtn = document.querySelector('.closeAyuda');

        const ayudaCalendario = `<h3>Uso de las reservas para las practicas</h3>
        <p>Aqu√≠ puedes ver todas las reservas solicitadas al profesor de practicas. Ver√°s el numero de clases que te quedan por realizar. Podr√°s solicitar practicas, anularlas y ver si el profesor las ha confirmado.</p>
        <ul>
            <li><strong>Calendario:</strong> Podr√°s ver todas las peticiones de reservas al profesor de practicas solicitadas por todos los alumnos, ya esten pendientes de confirmar por √©l, √≥ bien ya confirmadas.</li>
            <li><strong>Nueva solicitud de reserva:</strong> Podr√°s solicitar una reserva, eligiendo el dia y hora. Si chequeas la opcion de "Reservar este horario para 5 dias seguidos" se haran reserva de 5 dias a partir del dia elegido y a la misma hora.</li>
            <li><strong>Mis solicitudes de reserva:</strong> Visualizar√°s un listado con s√≥lo tus solicitudes de reservas de pr√°cticas. En el listado podr√°s anular las solicitudes, ya est√©n en el estado de "pendientes" √≥ "confirmadas". Pero estas √∫ltimas tiene un l√≠mite para su anulaci√≥n de hasta 24 horas antes del dia y hora de las reserva.</li>
            <li><strong>Reservas del d√≠a:</strong> Si haces clic en una fecha del calendario, visualizaras en este apartado todas las reservas solicitadas por todos los alumnos para ese dia tanto si est√°n pendientes como confirmadas.</li>
        </ul>
        `;

        closeVacacionesBtn.addEventListener('click', () => {
            popupHolidays.style.display = 'none';
        });

        btnAyuda.addEventListener('click', () => {
            popupAyuda.style.display = 'flex';
        });

        closeAyudaBtn.addEventListener('click', () => {
            popupAyuda.style.display = 'none';
        });

        btnInfo.addEventListener('click', () => {
            db.collection("usuarios_registrados").doc(usuarioActual.id).update({ info: true });
            popupInfo.style.display = 'none';
        });

        closeInfoBtn.addEventListener('click', () => {
            popupInfo.style.display = 'none';
        });

        popupAyuda.addEventListener('click', (e) => {
            if (e.target === popupAyuda) {
                popupAyuda.style.display = 'none';
            }
        });
    </script>

</body>
</html>
