<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Planificación Semanal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        let usuarioActual = {};

        function actualizarUI() {
            document.getElementById('week-range').textContent = 'Planificación semanal de prácticas para ' + usuarioActual.nombre;

            cargarTimeSlots();
            createCalendar();
            cargarDias();
            cargarAlumnosSelect();
            

            document.getElementById('calendar-grid').addEventListener('click', function (e) {
                const reservaDiv = e.target.closest('.reserva.pendiente');
                if (reservaDiv) {
                    e.stopPropagation();
                    const reservaId = reservaDiv.dataset.reservaId;
                    const email = reservaDiv.dataset.email;
                    mostrarMenuContextualPendiente(reservaId, email, reservaDiv);
                } else {
                    cerrarMenusContextuales();
                }
            });

            document.getElementById('contenidoAyuda').innerHTML = ayudaCalendario;
        }

        function dct(e) {
            const bytes = CryptoJS.AES.decrypt(e, "34#-2?579/fbh%$l(Oñh05t@");
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        }
        const firebaseConfig = dct("U2FsdGVkX1/wVoGGAPam24EP2C4b4c5OTPYzVoVmcY3hFxXHl+PfMkhFPUbKc8cRmwTvM44kMrg2sXgyT1mMB5/t3bUiIjIQDe1suqcD2SMvW7RVdJ1jCasaAMGo7a529bxkmCH6zKx+5iysRXw5PIzCKpUh1IGyItrCekPNJjt6zk4g8tP3qDNZizE4u62WVlvG4tp68iHasgwgYWkgzHhuN5/aYc4cRumfEDLPzz1Yf0EbSk3QM5QeGQDGficRCyNbgyaFbqj83wnjHWX4kZQ2iKddEdtNUqqjYHe0Mc0n5YI31rLP5o9dtAONCrrFRadsW0bfVC1ZCQWm5/JoLsi/6Xgxv0Oy3f7b8ncnNbCtsiYZhkgsPn7v2TU+CH/LBm5rUeVTji6lKNh2CYHs+A==");

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        // Inicializa Firestore si no lo has hecho
        const db = firebase.firestore();

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            try {
                const q = await db.collection('usuarios_registrados')
                    .where('usuarioId', '==', user.uid)
                    .get();
                if (!q.empty) {
                    usuarioActual.id = q.docs[0].id;
                    usuarioActual.nombre = q.docs[0].data().nombre;
                    usuarioActual.email = q.docs[0].data().email;
                    usuarioActual.perfil = q.docs[0].data().perfil;
                    usuarioActual.uid = user.uid;

                    // Control de acceso por perfil
                    if (usuarioActual.perfil !== "profesor") {
                        window.location.href = "index.html";
                        return;
                    }

                    document.body.classList.remove("oculto");

                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', actualizarUI);
                    } else {
                        actualizarUI();
                    }
                } else {
                    console.warn("No existe documento para ese usuarioId en usuarios_registrados");
                    window.location.href = "index.html";
                }
            } catch (err) {
                console.error("Error buscando documento de usuario registrado:", err);
                window.location.href = "index.html";
            }
        });
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            height: 100vh;
            overflow-y: auto;
        }

            body.oculto {
                visibility: hidden;
            }

        .calendar-container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(25,118,210,0.07);
            padding: 14px 10px 10px 10px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 18px;
            margin-bottom: 8px;
            background: #f5f8fd;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(25,118,210,0.04);
            padding: 4px 0;
        }

            .calendar-header h2 {
                margin: 0 8px;
                font-size: 1em;
                font-weight: 500;
                color: #1976d2;
                background: #e3eafc;
                border-radius: 4px;
                padding: 2px 10px;
            }

        .seccion-derecha {
            flex: 2;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .nav-button {
            padding: 0 10px;
            font-size: 1.6em;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1976d2 70%, #63a4ff 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(25,118,210,0.10);
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        }

            .nav-button:hover, .nav-button:focus {
                background: linear-gradient(135deg, #1565c0 70%, #1976d2 100%);
                box-shadow: 0 4px 12px rgba(25,118,210,0.18);
                transform: scale(1.07);
            }

        .leyenda-colores {
            display: flex;
            gap: 18px;
            margin: 10px 0 12px 0;
            justify-content: center;
        }

        .leyenda-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.95em;
        }

        .color-box {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1.2px solid #bbb;
        }

            .color-box.confirmada, .reserva.confirmada {
                background-color: #C8E6C9;
                border-color: #4CAF50;
            }

            .color-box.pendiente, .reserva.pendiente {
                background-color: #FFF9C4;
                border-color: #FFD600;
            }

            .color-box.anulada, .reserva.anulada {
                background-color: #FFCDD2;
                border-color: #EF5350;
            }

            .color-box.examen, .reserva.examen {
                background-color: #ef63f8;
                border-color: #4c4c4c;
            }

        .calendar-grid {
            display: grid;
            grid-template-columns: max-content repeat(5, minmax(50px, 1fr));
            gap: 1px;
            background-color: #e3eafc;
            border-radius: 7px;
            overflow: hidden;
        }

        .time-slot {
            background-color: #e3eafc;
            padding: 2px 8px;
            border-bottom: 1px solid #dde6f3;
            text-align: right;
            font-weight: 600;
            font-size: 1em;
            font-family: 'Open Sans', 'Segoe UI', Arial, sans-serif;
            color: #1976d2;
            letter-spacing: 0.5px;
            white-space: nowrap;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }


        .day-header {
            background-color: #1976d2;
            color: #fff;
            padding: 2px 0;
            text-align: center;
            font-weight: 500;
            font-size: 0.96em;
            border-bottom: 2px solid #1565c0;
            min-width: 0;
        }

        .calendar-cell {
            padding: 0 1px;
            background-color: #fff;
            border-bottom: 1px solid #e3eafc;
            min-height: 0;
            height: auto;
            position: relative;
            box-sizing: border-box;
        }

        .reserva {
            position: relative;
            cursor: pointer;
            display: inline-block;
            padding: 0 3px;
            margin: 0 0 1px 0;
            border-radius: 3px;
            font-size: 0.93em;
            font-weight: 500;
            box-sizing: border-box;
            line-height: 1.2;
            white-space: nowrap;
            border: 1px solid;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reserva-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 150px;
            background: #fff;
            border: 1px solid #1976d2;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(25, 103, 210, 0.09);
            z-index: 100;
            padding: 4px 0;
        }

            .reserva-menu.active {
                display: block;
            }

            .reserva-menu button {
                background: none;
                border: none;
                width: 100%;
                text-align: left;
                padding: 8px 14px;
                font-size: 0.98em;
                color: #1976d2;
                cursor: pointer;
                transition: background 0.15s;
            }

                .reserva-menu button:hover {
                    background: #e3eafc;
                }

        .reserva-context-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 140px;
            background: #fff;
            border: 1px solid #1976d2;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(25, 103, 210, 0.09);
            z-index: 1000;
            padding: 4px 0;
            display: block;
        }

            .reserva-context-menu.active {
                display: block;
            }

        .menu-item {
            padding: 8px 14px;
            font-size: 0.98em;
            color: #1976d2;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

            .menu-item:hover {
                background: #e3eafc;
            }

        .reserva {
            position: relative;
            cursor: pointer;
        }

        .fc-today-button {
            display: none !important;
        }

        .btn-ayuda {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #1976d2;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .popup-content {
            background: #fff;
            padding: 28px 32px;
            border-radius: 16px;
            max-width: 640px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            transform: translateY(0);
            animation: fadeInUp 0.4s ease-out;
            border: 1px solid rgba(25,118,210,0.1);
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 24px;
        }

            .popup-content h2 {
                font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
                font-size: 1.7rem;
                font-weight: 700;
                color: #1976d2;
                margin-top: 0;
                margin-bottom: 20px;
                text-align: center;
            }

            .popup-content h3 {
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 1.2rem;
                font-weight: 600;
                color: #1976d2;
                margin: 16px 0 8px 0;
            }
        .examen-item {
            max-width: 720px; /* Ampliado para más espacio horizontal */
            margin: 12px auto;
            background: #f7fafc;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(25, 103, 210, 0.08);
            padding: 2px 3px 1px 3px;
            font-family: 'Segoe UI', Arial, sans-serif;
            border: 1.2px solid #e3eafc;
        }

        #reserva-examen {
            text-align: center;
            color: #ef63f8;
            font-size: 0.9em;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: 0.4px;
        }

        .selects-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

            .selects-row label {
                font-weight: 500;
                color: #1976d2;
                font-size: 0.9em;
                margin-bottom: 0;
                white-space: nowrap;
            }

            .selects-row select {
                min-width: 0;
                font-size: 0.9em;
                color: #1976d2;
                border-radius: 5px;
                border: 1px solid #bcdffb;
                background: #fff;
                padding: 5px 10px;
                outline: none;
                transition: border 0.2s;
                flex: 1 1 0;
            }

        #alumno {
            flex: 2 1 0; /* El select de alumno ocupa el doble de espacio */
            max-width: 350px; /* Puedes ajustar según el largo de los nombres */
        }

        .selects-row select:focus {
            border-color: #1976d2;
            background: #e3eafc;
        }

        .cta-btn-solicitar {
            width: 100%;
            padding: 8px 0;
            background: linear-gradient(90deg, #1976d2 60%, #63a4ff 100%);
            color: #fff;
            font-weight: 600;
            font-size: 0.9em;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(25, 103, 210, 0.09);
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.18s, box-shadow 0.18s;
        }

            .cta-btn-solicitar:hover, .cta-btn-solicitar:focus {
                background: linear-gradient(90deg, #1565c0 60%, #1976d2 100%);
                box-shadow: 0 4px 16px rgba(25, 103, 210, 0.13);
            }

        #examenMsg {
            margin-top: 10px;
            min-height: 18px;
            text-align: center;
            font-size: 0.96em;
            font-weight: 500;
            color: #388e3c;
            background: #eafaf1;
            border-radius: 4px;
            padding: 5px 0;
            display: none;
        }



    </style>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:600&display=swap" rel="stylesheet">
</head>
<body class="oculto">
    <div class="calendar-container">
        <div class="calendar-header">
            <button class="nav-button" title="Semana anterior" onclick="previousWeek()">&#8592;</button>
            <div class="week-info">
                <h2 id="week-range"></h2>
            </div>
            <button class="nav-button" title="Semana siguiente" onclick="nextWeek()">&#8594;</button>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
        <!-- Leyenda de colores -->
        <div class="leyenda-colores">
            <div class="leyenda-item">
                <div class="color-box pendiente"></div>
                <span>Pendiente</span>
            </div>
            <div class="leyenda-item">
                <div class="color-box confirmada"></div>
                <span>Confirmada</span>
            </div>
            <div class="leyenda-item">
                <div class="color-box examen"></div>
                <span>Examen</span>
            </div>
        </div>
        <div class="examen-item">
            <h2 id="reserva-examen">Reservas para exámenes</h2>
            <form id="formExamen">
                <div class="form-row selects-row">
                    <label for="alumno">Alumno:</label>
                    <select id="alumno" required></select>
                    <label for="dia">Día:</label>
                    <select id="dia" required></select>
                    <label for="hora">Hora:</label>
                    <select id="hora" required></select>
                </div>
                <button type="submit" class="cta-btn-solicitar">Reservar examen</button>
                <div id="examenMsg"></div>
            </form>
        </div>

    </div>

    <div class="seccion-derecha">
        <button id="btnAyuda" class="btn-ayuda">
            <i class="fas fa-question-circle"></i>
        </button>
    </div>

    <div id="popupAyuda" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h2>Ayuda</h2>
            <div id="contenidoAyuda">
                <!-- Aquí va el contenido de ayuda específico para cada página -->
            </div>
        </div>
    </div>
    <script>

        const settings = { experimentalForceLongPolling: true, merge: true };
        db.settings(settings);

        function clearCollection(path) {
            const ref = db.collection(path)
            ref.onSnapshot((snapshot) => {
                snapshot.docs.forEach((doc) => {
                    ref.doc(doc.id).delete()
                })
            })
        }

        //clearCollection('creditos')

        // Tramos horarios como en tu select
        let timeSlots = []; // Inicialmente vacío

        /*async function cargarTimeSlots() {
            try {
                const doc = await db.collection("configuracion").doc("horarios").get();
                if (doc.exists && Array.isArray(doc.data().slots)) {
                    timeSlots = doc.data().slots;

                    // Ordenar los tramos horarios por la hora de inicio
                    timeSlots.sort((a, b) => {
                        // Extrae la hora de inicio (antes del primer espacio o "a")
                        const horaA = a.split(" a ")[0];
                        const horaB = b.split(" a ")[0];
                        // Convierte a minutos para comparar
                        const [hA, mA] = horaA.split(":").map(Number);
                        const [hB, mB] = horaB.split(":").map(Number);
                        return hA * 60 + mA - (hB * 60 + mB);
                    });

                    createCalendar();
                    cargarHoras();
                } else {
                    console.error("No se encontraron tramos horarios en Firestore.");
                    // Usar valores por defecto si es necesario
                    timeSlots = ["07:30 a 08:50", "09:00 a 10:20", "10:30 a 11:50", "12:00 a 13:20", "13:30 a 14:50"];
                    //updateWeekDisplay();
                    createCalendar();
                }
            } catch (error) {
                console.error("Error al cargar los tramos horarios:", error);
                // Usar valores por defecto si hay error
                timeSlots = ["07:30 a 08:50", "09:00 a 10:20", "10:30 a 11:50", "12:00 a 13:20", "13:30 a 14:50"];
                //updateWeekDisplay();
                createCalendar();
            }
        }*/

        async function cargarTimeSlots() {
            try {
                // Obtiene solo los horarios activados y los ordena por 'orden'
                const snapshot = await db.collection("horarios")
                    .where("Activo", "==", true)
                    .orderBy("orden", "asc")
                    .get();

                // Los tramos horarios estarán en los IDs de cada documento
                timeSlots = [];
                snapshot.forEach(doc => {
                    timeSlots.push(doc.id); // el ID es el tramo, ej: "09:00 a 10:20"
                });
                
                if (timeSlots.length > 0) {
                    createCalendar();
                } else {
                    console.error("No se encontraron tramos horarios activos en Firestore.");
                    // Valores por defecto
                    timeSlots = ["07:30 a 08:50", "08:50 a 10:10", "10:10 a 11:30", "11:30 a 12:50", "12:50 a 14:10", "15:10 a 16:30", "16:30 a 17:50", "17:50 a 19:10", "19:10 a 20:30", "20:30 a 21:50"];
                    createCalendar();
                }
            } catch (error) {
                console.error("Error al cargar los tramos horarios:", error);
                timeSlots = ["07:30 a 08:50", "08:50 a 10:10", "10:10 a 11:30", "11:30 a 12:50", "12:50 a 14:10", "15:10 a 16:30", "16:30 a 17:50", "17:50 a 19:10", "19:10 a 20:30", "20:30 a 21:50"];
                createCalendar();
            }
        }

        // Utilidad: formato YYYY-MM-DD
        function toISODate(date) {
            return date.toISOString().split('T')[0];
        }

        // Cargar días de la semana actual y la siguiente
        function cargarDias() {
            const selectDia = document.getElementById('dia');
            selectDia.innerHTML = "";
            const hoy = new Date();
            for (let i = 1; i < 15; i++) {
                const fecha = new Date(hoy);
                fecha.setDate(hoy.getDate() + i);
                const diaSemana = fecha.getDay(); // 0=domingo, 6=sábado
                if (diaSemana !== 0 && diaSemana !== 6) { // Excluye sábados y domingos
                    const fechaISO = toISODate(fecha);
                    const texto = fecha.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                    const option = document.createElement('option');
                    option.value = fechaISO;
                    option.textContent = texto.charAt(0).toUpperCase() + texto.slice(1);
                    selectDia.appendChild(option);
                }

            }
        }
        
        async function cargarHoras() {
            // Añade cada tramo como opción
            //console.table(timeSlots);
            //let timeExams = ["08:00 a 08:30", "08:30 a 09:00", "09:00 a 09:30", "09:30 a 10:00", "10:00 a 10:30", "10:30 a 11:00", "11:00 a 11:30"];
            const selectHora = document.getElementById('hora');
            if (!selectHora) return;

            // Limpia las opciones anteriores
            selectHora.innerHTML = '';

            timeSlots.forEach(timeslot => {
                const option = document.createElement('option');
                option.value = timeslot;
                option.textContent = timeslot;
                selectHora.appendChild(option);
            });
        }

        async function cargarAlumnosSelect() {
            const select = document.getElementById('alumno');
            select.innerHTML = '<option value="">Selecciona un alumno</option>';

            try {
                const snapshot = await db.collection("usuarios_registrados")
                    .where("perfil", "==", "alumno")
                    .where("habilitado", "==", true)
                    .orderBy("nombre") // Opcional: ordena por nombre
                    .get();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Usa "apellidos" o "Apellidos" según tu base de datos
                    const apellidos = data.apellidos || data.Apellidos || "";
                    const option = document.createElement('option');
                    option.value = doc.id; // O data.usuarioId, según tu lógica
                    option.textContent = `${data.nombre} ${apellidos}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar alumnos:", error);
                select.innerHTML = '<option value="">Error al cargar alumnos</option>';
            }
        }

        let currentDate = new Date(); // Fecha actual
        currentDate.setHours(0, 0, 0, 0); // Normaliza la hora


        function formatDate(date) {
            // Formatea en hora local (ej: 2025-05-19)
            return date.toLocaleDateString('en-CA'); // Formato "YYYY-MM-DD" en local
        }

        // Devuelve { start, end } para consultas
        function getWeekRange(date) {
            const start = new Date(date);
            start.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1));
            start.setHours(0, 0, 0, 0);

            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 59, 999);

            return { start, end };
        }

        // Devuelve array de fechas para la UI
        function getWeekDatesArray(date) {
            const start = new Date(date);
            start.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)); // Lunes
            start.setHours(0, 0, 0, 0);

            const dates = [];
            for (let i = 0; i < 5; i++) { // Solo 5 días (lunes a viernes)
                const current = new Date(start);
                current.setDate(start.getDate() + i);
                dates.push(current);
            }
            return dates;
        }


        function updateWeekDisplay() {
            const weekDates = getWeekDatesArray(currentDate);
            const start = weekDates[0].toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            const end = weekDates[4].toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); // <--- Índice 4 (viernes)
            document.getElementById("week-range").textContent = `${start} - ${end}`;
        }

        function createCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            const weekDates = getWeekDatesArray(currentDate);

            // 1. Fila del mes (esquina + mes)
            // Obtén el mes y el año del primer día de la semana
            const mes = weekDates[0].toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            // Esquina superior izquierda vacía
            grid.innerHTML += `<div class="time-slot"></div>`;
            // Mes (ocupa 5 columnas, igual que los días)
            grid.innerHTML += `<div class="month-header" style="grid-column: 2 / span 5; text-align:center; font-weight:bold; font-size:1.1em; background:#e3eafc; color:#1976d2; border-radius:6px 6px 0 0;">${mes.charAt(0).toUpperCase() + mes.slice(1)}</div>`;

            // Esquina superior izquierda
            grid.innerHTML += `<div class="time-slot"></div>`;

            // Encabezados de los días de la semana (solo lunes a viernes)
            weekDates.forEach(date => {
                grid.innerHTML += `<div class="day-header">${date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })}</div>`;
            });

            // Filas: cada tramo horario
            timeSlots.forEach(slot => {
                grid.innerHTML += `<div class="time-slot">${slot}</div>`;
                weekDates.forEach(date => {
                    grid.innerHTML += `<div class="calendar-cell" data-date="${formatDate(date)}" data-hora="${slot}"></div>`;
                });
            });

            loadReservations();
        }

        function getWeekDates(date) {
            const start = new Date(date);
            start.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1));
            start.setHours(0, 0, 0, 0); // <--- ¡Importante! Inicia a las 00:00

            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 59, 999); // <--- Termina a las 23:59

            return { start, end };
        }

        async function loadReservations() {
            try {
                // Limpia reservas anteriores
                document.querySelectorAll('.reserva').forEach(el => el.remove());

                // Obtén el rango de la semana (para consulta)
                const { start, end } = getWeekRange(currentDate);
                //console.log("Consultando desde:", start, "hasta:", end);

                // Consulta Firestore
                const q = db.collection("reservas")
                    .where("fecha", ">=", firebase.firestore.Timestamp.fromDate(start))
                    .where("fecha", "<=", firebase.firestore.Timestamp.fromDate(end))
                    .where('estado', 'in', ['confirmada', 'pendiente', 'examen']) // Solo estos estados
                    .orderBy('fecha', 'desc');

                const querySnapshot = await q.get();

                // Limpia reservas anteriores
                document.querySelectorAll('.reserva').forEach(el => el.remove());

                // Procesa e inserta en el calendario
                querySnapshot.forEach(doc => {
                    const reserva = doc.data();
                    reserva.id = doc.id;
                    const fecha = reserva.fecha.toDate();
                    const fechaFormateada = formatDate(fecha);
                    const hora = reserva.hora.trim();
                    const estado = reserva.estado.toLowerCase(); // Asegura minúsculas                    
                    const cell = document.querySelector(`[data-date="${fechaFormateada}"][data-hora="${hora}"]`);
                    /*const cells = document.querySelectorAll(`[data-date="${fechaFormateada}"]`);
                    cells.forEach(cell => {
                        console.log('estado:', estado);
                        console.log('fecha Firestore:', fechaFormateada);
                        console.log('Posible hora:', cell.getAttribute('data-hora'));
                        console.log('hora Firestore:', hora);
                    });*/
                    //console.log('Buscando celda:', `[data-date="${fechaFormateada}"][data-hora="${hora}"]`);
                    
                    //console.log('Reserva:', fechaFormateada, hora);
                    //console.log('¿Existe cells?', !!cells, cells);

                    if (cell) {
                        const reservaElement = document.createElement('div');
                        reservaElement.className = `reserva ${estado}`; // Clase dinámica según estado
                        //reservaElement.innerHTML = `<span>${reserva.usuarioNombre}</span><small>${reserva.estado}</small>`;
                        reservaElement.innerHTML = `<span>${reserva.usuarioNombre}</span>`;
                        reservaElement.dataset.reservaId = reserva.id; // Añade el id
                        reservaElement.dataset.estado = estado;
                        reservaElement.dataset.email = reserva.usuarioEmail || ''; // Si tienes el email                                                   
                       
                        if (estado === 'pendiente' || estado === 'confirmada' || estado === 'examen') {
                            reservaElement.addEventListener('click', function (e) {
                                e.stopPropagation();
                                mostrarMenuContextual(reserva, reservaElement, estado);
                            });
                        }

                        cell.appendChild(reservaElement);
                    }
                });

            } catch (error) {
                console.error("Error al cargar reservas:", error);
            }
        }

        async function previousWeek() {
            currentDate.setDate(currentDate.getDate() - 7);
            //updateWeekDisplay();
            await createCalendar(); // Espera a que termine de crear el calendario
            await loadReservations();
        }

        async function nextWeek() {
            currentDate.setDate(currentDate.getDate() + 7);
            //updateWeekDisplay();
            await createCalendar(); // Espera a que termine de crear el calendario
            await loadReservations();
        }

        function cerrarMenusContextuales() {
            document.querySelectorAll('.reserva-context-menu').forEach(menu => menu.remove());
        }

        function mostrarMenuContextual(reserva, divReserva, estado) {
            cerrarMenusContextuales();

            const menu = document.createElement('div');
            menu.className = 'reserva-context-menu';
            menu.style.position = 'fixed';

            menu.innerHTML = `<div class="menu-item" onclick="anularReservaProfesor('${reserva.id}', '${reserva.usuarioEmail}')">Anular</div>`;

            if (estado == "pendiente") menu.innerHTML = menu.innerHTML + `<div class="menu-item" onclick="confirmarReservaProfesor('${reserva.id}', '${reserva.usuarioEmail}')">Confirmar</div>`;

            // Posiciona el menú donde está el divReserva
            const rect = divReserva.getBoundingClientRect();
            menu.style.top = (rect.bottom + window.scrollY) + "px";
            menu.style.left = (rect.left + window.scrollX) + "px";
            menu.style.zIndex = 9999;

            document.body.appendChild(menu);

            setTimeout(() => {
                document.addEventListener('click', cerrarMenusContextuales, { once: true });
            }, 10);
        }

        // Al pintar cada reserva pendiente:
        function renderReservaEnCelda(reserva, cell) {
            const div = document.createElement('div');
            div.className = `reserva ${reserva.estado}`;
            div.textContent = reserva.usuarioNombre;

            if (reserva.estado === 'pendiente') {
                div.addEventListener('click', function (e) {
                    e.stopPropagation();
                    mostrarMenuContextual(reserva, div);
                });
            }

            cell.appendChild(div);
        }

        async function anularReservaProfesor(reservaId, email) {
            try {
                // 1. Lee la reserva para obtener los datos
                const reservaDoc = await db.collection("reservas").doc(reservaId).get();
                if (!reservaDoc.exists) throw new Error("Reserva no encontrada");
                const reservaData = reservaDoc.data();
                const usuarioIdAlumno = reservaData.usuarioId; // UID del alumno

                // 2. Anula la reserva
                await db.collection("reservas").doc(reservaId).update({ estado: "anulada" });
                cerrarMenusContextuales();

                // 3. Busca el documento del alumno en usuarios_registrados
                const userQuery = await db.collection("usuarios_registrados")
                    .where("usuarioId", "==", usuarioIdAlumno)
                    .get();

                if (!userQuery.empty) {
                    const userDocRef = userQuery.docs[0].ref;
                    const datos = userQuery.docs[0].data();
                    const creditosActuales = typeof datos.creditos === "number" ? datos.creditos : 0;
                    const creditosDespues = creditosActuales + 1;
                    //console.log("creditosActuales: " + creditosActuales + "creditosDespues" + creditosDespues);
                    await userDocRef.update({
                        creditos: creditosDespues
                    });

                    //console.log("Usuario actual: ", usuarioActual.perfil);
                    // 4. Log de créditos con reservasImplicadas
                    await logCredito({
                        usuarioId: datos.usuarioId,
                        email: datos.email,
                        perfil: usuarioActual.perfil,
                        creditosAntes: creditosActuales,
                        tipo: "sumar",
                        creditosDespues: creditosDespues,
                        reservasImplicadas: [{
                            id: reservaId,
                            fecha: reservaData.fecha.toDate().toISOString().split('T')[0],
                            hora: reservaData.hora
                        }]
                    });
                } else {
                    console.warn("No se encontró el documento del alumno para sumar créditos.");
                }

                loadReservations(); // O la función que recarga tu grid
                //await enviarEmailReserva(email, "anulada");
            } catch (error) {
                alert("Error al anular la reserva");
            }
        }

        async function confirmarReservaProfesor(reservaId, email) {
            try {
                // 1. Confirma la reserva actual
                await db.collection("reservas").doc(reservaId).update({ estado: "confirmada" });

                // 2. Recupera los datos de la reserva confirmada para obtener usuarioId y fecha
                const reservaDoc = await db.collection("reservas").doc(reservaId).get();
                if (!reservaDoc.exists) throw new Error("Reserva no encontrada");
                const reservaData = reservaDoc.data();
                const usuarioId = reservaData.usuarioId;
                const fechaConfirmada = reservaData.fecha; // Timestamp de Firestore

                // 3. Busca reservas pendientes del mismo usuario en días anteriores
                /*const reservasPendientes = await db.collection("reservas")
                    .where("usuarioId", "==", usuarioId)
                    .where("estado", "==", "pendiente")
                    .where("fecha", "<=", fechaConfirmada)
                    .get();*/

                // 4. Construye el array de reservas implicadas
                const reservasImplicadas = [{
                    id: reservaId,
                    fecha: reservaData.fecha.toDate().toISOString().split('T')[0],
                    hora: reservaData.hora
                }];

                // 5. Anula todas esas reservas pendientes anteriores y añade al array
                /*for (const doc of reservasPendientes.docs) {
                    const dataPendiente = doc.data();
                    reservasImplicadas.push({
                        id: doc.id,
                        fecha: dataPendiente.fecha.toDate().toISOString().split('T')[0],
                        hora: dataPendiente.hora
                    });
                    await anularReservaProfesor(doc.id, dataPendiente.usuarioEmail);
                }*/

                // 6. Recupera los créditos antes y después de la operación
                const userQuery = await db.collection("usuarios_registrados")
                    .where("usuarioId", "==", usuarioId)
                    .get();

                if (!userQuery.empty) {
                    const userDocRef = userQuery.docs[0].ref;
                    const datos = userQuery.docs[0].data();
                    const creditosAntes = typeof datos.creditos === "number" ? datos.creditos : 0;
                    // Como anularReservaProfesor suma 80 por cada reserva anulada,
                    // calculamos los créditos después:
                    const creditosDespues = creditosAntes; // ya están actualizados tras las anulaciones

                    await logCredito({
                        usuarioId: datos.usuarioId,
                        email: datos.email,
                        perfil: usuarioActual.perfil,
                        creditosAntes: creditosAntes, // antes de la confirmación (y después de las anulaciones)
                        tipo: "confirmar",
                        creditosDespues: creditosDespues,
                        reservasImplicadas
                    });
                }
                //console.log(usuarioActual.perfil);
                cerrarMenusContextuales();
                loadReservations();
                // await enviarEmailReserva(email, "confirmada");
            } catch (error) {
                alert("Error al confirmar la reserva");
                console.error(error);
            }
        }

        async function logCredito({
            usuarioId,
            email,
            perfil,
            creditosAntes,
            tipo, // "sumar" o "restar"
            creditosDespues,
            reservasImplicadas
        }) {
            try {
                await db.collection("logcreditos").add({
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    usuarioId,
                    email,
                    perfil,
                    creditosAntes,
                    tipo,
                    creditosDespues,
                    reservasImplicadas
                });
                console.log("Log de crédito guardado correctamente");
            } catch (error) {
                console.error("Error al guardar el log de créditos:", error);
            }
        }

        async function enviarEmailReserva(email, nuevoEstado) {
            if (!email) return;
            const asunto = nuevoEstado === "confirmada"
                ? "Tu reserva ha sido confirmada"
                : "Tu reserva ha sido anulada";
            const cuerpo = nuevoEstado === "confirmada"
                ? "¡Enhorabuena! Tu reserva ha sido confirmada por el profesor."
                : "Tu reserva ha sido anulada por el profesor. Si tienes dudas, contacta con tu centro.";
            await db.collection("mail").add({
                to: email,
                message: {
                    subject: asunto,
                    html: `<p>${cuerpo}</p>`
                }
            });
        }

        const btnAyuda = document.getElementById('btnAyuda');
        const popupAyuda = document.getElementById('popupAyuda');
        const closeBtn = document.querySelector('.close');

        const ayudaCalendario = `<h3>Uso de la planificacion de las reservas para practicas</h3>
<p>Aquí puedes ver todas las reservas solicitadas al profesor de practicas y anular o confirmar clases.</p>
<ul>
                <li><strong>Planificación semanal de prácticas:</strong> Visualizarás las practicas solicitadas por los alumnos. Al clickar en una reserva podrás anularla o confirmarla.</li>
</ul>
`;

        btnAyuda.addEventListener('click', () => {
            popupAyuda.style.display = 'flex';
        });

        closeBtn.addEventListener('click', () => {
            popupAyuda.style.display = 'none';
        });

        // Cierra el popup si se hace clic fuera del contenido
        popupAyuda.addEventListener('click', (e) => {
            if (e.target === popupAyuda) {
                popupAyuda.style.display = 'none';
            }
        });

        document.getElementById('formExamen').addEventListener('submit', async function (e) {
            e.preventDefault();

            const alumnoId = document.getElementById('alumno').value;
            const dia = document.getElementById('dia').value; // formato YYYY-MM-DD
            const hora = document.getElementById('hora').value;

            // Recuperar nombre y apellidos del alumno seleccionado
            const alumnoDoc = await db.collection('usuarios_registrados').doc(alumnoId).get();
            if (!alumnoDoc.exists) {
                document.getElementById('examenMsg').textContent = "No se encontró el alumno seleccionado.";
                document.getElementById('examenMsg').style.display = "block";
                return;
            }
            const alumno = alumnoDoc.data();

            // Convertir el día seleccionado a Timestamp de Firestore
            const fechaTimestamp = firebase.firestore.Timestamp.fromDate(new Date(dia + "T00:00:00"));

            // Crear la reserva en Firestore
            await db.collection('reservas').add({
                usuarioId: alumnoId,
                usuarioNombre: alumno.nombre,
                Apellidos: alumno.apellidos || alumno.Apellidos || "",
                fecha: fechaTimestamp, // Ahora es un Timestamp igual que 'timestamp'
                hora: hora,
                estado: "examen",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            document.getElementById('examenMsg').textContent = "Reserva de examen registrada correctamente.";
            document.getElementById('examenMsg').style.display = "block";
            document.getElementById('formExamen').reset();
            await createCalendar();
        });


    </script>
</body>
</html>
