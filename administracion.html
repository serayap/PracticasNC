<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administracion</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- html a Pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.0/html2pdf.bundle.min.js"></script>
    <script>
        let usuarioActual = {};

        function actualizarUI() {
            document.getElementById('tituloReservas').textContent = `Administración de las reservas de prácticas con Carlos`;

            cargarListadoAlumnos();
            cargarReservas();

            //document.getElementById('formReserva').addEventListener('submit', crearReserva);
            document.getElementById('contenidoAyuda').innerHTML = ayudaCalendario;
        }

        function dct(e) {
            const bytes = CryptoJS.AES.decrypt(e, "34#-2?579/fbh%$l(Oñh05t@");
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        }
        const firebaseConfig = dct("U2FsdGVkX1/wVoGGAPam24EP2C4b4c5OTPYzVoVmcY3hFxXHl+PfMkhFPUbKc8cRmwTvM44kMrg2sXgyT1mMB5/t3bUiIjIQDe1suqcD2SMvW7RVdJ1jCasaAMGo7a529bxkmCH6zKx+5iysRXw5PIzCKpUh1IGyItrCekPNJjt6zk4g8tP3qDNZizE4u62WVlvG4tp68iHasgwgYWkgzHhuN5/aYc4cRumfEDLPzz1Yf0EbSk3QM5QeGQDGficRCyNbgyaFbqj83wnjHWX4kZQ2iKddEdtNUqqjYHe0Mc0n5YI31rLP5o9dtAONCrrFRadsW0bfVC1ZCQWm5/JoLsi/6Xgxv0Oy3f7b8ncnNbCtsiYZhkgsPn7v2TU+CH/LBm5rUeVTji6lKNh2CYHs+A==");

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        // Inicializa Firestore si no lo has hecho
        const db = firebase.firestore();

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            try {
                const q = await db.collection('usuarios_registrados')
                    .where('usuarioId', '==', user.uid)
                    .get();
                if (!q.empty) {
                    usuarioActual.id = q.docs[0].id;
                    usuarioActual.nombre = q.docs[0].data().nombre;
                    usuarioActual.email = q.docs[0].data().email;
                    usuarioActual.perfil = q.docs[0].data().perfil;
                    usuarioActual.uid = user.uid;

                    // Control de acceso por perfil
                    if (usuarioActual.perfil !== "administracion") {
                        window.location.href = "index.html";
                        return;
                    }

                    document.body.classList.remove("oculto");

                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', actualizarUI);
                    } else {
                        actualizarUI();
                    }
                } else {
                    console.warn("No existe documento para ese usuarioId en usuarios_registrados");
                    window.location.href = "index.html";
                }
            } catch (err) {
                console.error("Error buscando documento de usuario registrado:", err);
                //window.location.href = "index.html";
            }
        });

    </script>
    <style>
        body {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 60%, #e0e0e0 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

            body.oculto {
                visibility: hidden;
            }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            margin: 0 auto;
            gap: 0;
        }

        .subcabecera-creditos {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
            font-size: 1.1em;
            padding: 8px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(25,103,210,0.07);
        }


        .cabecera-principal {
            font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
            font-size: 1.3rem; /* Un poco más pequeño */
            font-weight: 900;
            background: linear-gradient(90deg, #1976d2 20%, #42a5f5 80%);
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px; /* Menos separación */
            text-align: center;
            margin: 16px auto 8px auto; /* Mucho menos margen arriba y abajo */
            text-shadow: 0 1px 4px rgba(25, 118, 210, 0.08); /* Sombra más sutil */
            animation: gradient-move 3s linear infinite alternate;
            padding: 4px 0; /* Menos padding vertical */
            border-bottom: 2px solid #1976d2; /* Más fino */
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 12px rgba(25, 118, 210, 0.05); /* Sombra más pequeña */
            max-width: 1000px; /* Más estrecho */
        }

        .reserva-item-compacta {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Espacio entre texto y botón */
            gap: 8px;
            padding: 2px 0;
            font-size: 0.95em;
            white-space: nowrap; /* Evita saltos de línea */
            border: 1px solid gray; /* Borde azul */
            border-radius: 6px; /* Esquinas redondeadas */
            background: #f5faff; /* Fondo suave opcional */
        }

        .cta-btn-solicitar {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 6px auto; /* Centrado con margen vertical */
            background: linear-gradient(90deg, #1976d2 60%, #63a4ff 100%);
            color: #fff;
            text-decoration: none;
            padding: 4px 6px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.13);
            border: none;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s, color 0.2s, transform 0.1s;
            min-width: 150px;
            max-width: 100%;
        }

            .cta-btn-solicitar:hover {
                background: linear-gradient(90deg, #1565c0 40%, #1976d2 100%);
                box-shadow: 0 8px 24px rgba(25, 118, 210, 0.21);
                color: #fff;
                transform: scale(1.05);
            }


        .cta-btn-pendiente {
            display: flex;
            flex-shrink: 0;
            justify-content: flex-end;
            gap: 8px;
            background: linear-gradient(90deg, #ff9800 60%, #ffb347 100%); /* naranja vibrante */
            color: #fff; /* texto oscuro para destacar sobre naranja claro */
            text-decoration: none;
            padding: 2px 10px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 300;
            box-shadow: 0 2px 12px rgba(255, 152, 0, 0.10);
            border: none;
            transition: background 0.2s, box-shadow 0.2s, color 0.2s;
        }

            .cta-btn-pendiente:hover {
                background: linear-gradient(90deg, #ff5722 30%, #ff9800 100%); /* naranja más intenso al pasar el ratón */
                color: #fff; /* texto blanco para máximo contraste */
                box-shadow: 0 4px 16px rgba(255, 152, 0, 0.18);
            }

        .cta-btn-confirmada {
            display: flex;
            flex-shrink: 0; /* El botón nunca se encoge */
            justify-content: flex-end; /* Alinea todo a la derecha */
            gap: 8px; /* Espacio entre botones, opcional */
            background: linear-gradient(90deg, #56ab2f 30%, #a8e063 100%);
            color: #fff;
            text-decoration: none;
            padding: 2px 10px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 300;
            box-shadow: 0 2px 12px rgba(25,103,210,0.08);
            border: none;
            transition: background 0.2s, box-shadow 0.2s;
        }

            .cta-btn-confirmada:hover {
                background: linear-gradient(90deg, #ff4b2b 30%, #ff416c 100%);
                box-shadow: 0 4px 16px rgba(255, 65, 108, 0.15);
                color: #fff; /* Opcional, por si quieres asegurar el color */
                /* Puedes agregar más efectos si lo deseas */
            }

        .cta-btn-confirmada-disabled {
            background: linear-gradient(90deg, #bdbdbd 30%, #eeeeee 100%);
            color: #757575;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 300;
            padding: 2px 10px;
            box-shadow: 0 2px 8px rgba(189, 189, 189, 0.13);
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: auto; /* Permite mostrar el tooltip aunque esté deshabilitado */
            position: relative;
            transition: background 0.2s, color 0.2s, opacity 0.2s;
        }

            /* Tooltip personalizado al pasar el ratón */
            .cta-btn-confirmada-disabled[title]:hover::after {
                content: attr(title);
                position: absolute;
                left: 50%;
                top: 110%;
                transform: translateX(-50%);
                background: #333;
                color: #fff;
                padding: 4px 10px;
                border-radius: 5px;
                font-size: 0.85em;
                white-space: nowrap;
                z-index: 10;
                opacity: 0.95;
                pointer-events: none;
            }


        @keyframes gradient-move {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 100% 50%;
            }
        }

        .cabecera {
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: #1976d2;
            background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 8px 16px;
            border-radius: 8px;
            margin-bottom: 18px;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.07);
            display: inline-block;
            text-align: center;
        }

        .arriba {
            display: flex;
            flex-direction: row;
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .columna-alumnos, .columna-calendario {
            width: 50%;
            min-width: 0; /* Evita desbordamiento */
            box-sizing: border-box;
        }

        .nuevoalumno, .listadoalumno {
            /*flex: 1 1 0;*/
            min-width: 300px;
            background: #fff;
            border-radius: 12px;
            padding: 2px 10px 10px 10px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centra todo el contenido hijo horizontalmente */
        }

        #listadoAlumnos {
            width: 100%;
            max-height: 300px; /* Ajusta la altura máxima según tu diseño */
            overflow-y: auto; /* Activa el scroll vertical cuando sea necesario */
            border: 1px solid #e0e0e0; /* Opcional: para delimitar visualmente el área */
            padding: 8px 0;
            background: #fff;
        }

        #formReserva .cta-btn {
            display: block;
            margin: 16px auto 0 auto; /* Centra horizontalmente */
        }

        #calendar-container {
            width: 500px; /* Cambia a tu gusto */
            margin: 0 auto; /* Centra el calendario */
        }

        #calendar {
            min-width: 200px;
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            margin-bottom: 0;
            width: 100%;
            box-sizing: border-box;
            height: 350px !important; /* Altura máxima total */
        }

        .fc-toolbar {
            padding: 2px 0 !important; /* Reduce el espacio vertical */
            min-height: 0 !important;
            padding-bottom: 4px !important;
            margin-bottom: 8px !important;
        }

        .fc-toolbar-title {
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            font-size: 1.5rem !important;
            font-weight: 5700;
            color: #1565c0;
            padding: 2px 8px !important;
            letter-spacing: 1px;
        }

        .fc .fc-button {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background 0.2s;
        }

            .fc .fc-button:hover,
            .fc .fc-button:focus {
                background: #1565c0;
            }

        .seccion-derecha {
            flex: 2;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        /* Panel de reservas del día */
        .reservas-dia {
            background: #fff;
            border-radius: 12px;
            padding: 2px 2px 2px 2px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            max-height: 400px;
            overflow-y: auto;
            text-align: center;
        }

        /* Elementos de la lista */
        #lista-reservas-dia, #datosAlumno {
            margin-top: 15px;
        }

        .reserva-dia-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
        }

            .reserva-dia-item.pendiente {
                border-color: #ff9800;
            }

            .reserva-dia-item.confirmada {
                border-color: #4caf50;
            }

            .reserva-dia-item.anulada {
                border-color: #ff6a6a;
            }

            .reserva-dia-item.examen {
                border-color: #ef63f8;
            }

        @media (max-width: 900px) {
            .arriba {
                flex-direction: column;
                gap: 0;
            }

            #calendar {
                min-width: 0;
                width: 100%;
                margin-bottom: 20px;
            }


            /* En tu media query para pantallas grandes */
            #calendar-container {
                width: 700px !important; /* Mayor ancho del contenedor */
            }

            .fc-daygrid-day {
                min-width: 80px !important; /* Ancho mayor para celdas */
            }

            .columna-alumnos, .columna-calendario {
                width: 100%;
            }
        }


        /* Añade esto para control general de altura */
        .fc .fc-daygrid-day {
            height: 40px !important; /* Altura fija para todas las celdas */
        }

        .fc-daygrid-day-events {
            /*min-height: 18px !important;
            margin-top: auto;*/
            min-height: 0 !important;
            margin-top: auto !important; /* Empuja los eventos hacia abajo */
            flex-grow: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box !important;
        }

        .fc-daygrid-day-bg {
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box !important;
        }

        .fc-daygrid-day-number {
            line-height: 1 !important;
            padding: 2px !important;
            font-size: 0.85em !important;
        }

        .fc-dot-pendiente,
        .fc-dot-confirmada {
            transform: scale(0.7) !important;
            margin: 0 1px !important;
        }

        .fc-daygrid-day {
            height: 32px !important; /* Altura máxima de la celda */
            min-height: 32px !important;
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box !important;
        }

        .fc-daygrid-day-frame {
            /*height: 100%;
            display: flex;
            flex-direction: column;*/
            height: 100% !important;
            min-height: 100% !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important;
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box !important;
        }

        .fc-daygrid-day-top {
            flex-wrap: nowrap !important;
            gap: 2px !important;
            height: 24px !important; /* Altura fija para la sección superior */
            min-height: 24px !important;
            margin: 0 !important;
            padding: 0 !important;
            flex-shrink: 0 !important;
            box-sizing: border-box !important;
        }

        /* Ajusta el header del calendario */
        .fc-col-header {
            height: 30px !important;
        }

        .fc-col-header-cell {
            height: 100% !important;
            padding: 2px !important;
        }

        .fc-scrollgrid {
            border: none !important;
        }

        .fc-daygrid-body tr {
            height: 32px !important;
            min-height: 32px !important;
            max-height: 32px !important;
        }

        .fc-scrollgrid-sync-table {
            height: 100% !important;
            min-height: 0 !important;
        }

        /* Contenedor de la vista */
        .fc-view-harness {
            min-height: 0 !important;
        }

        .leyenda-colores {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
        }

        .leyenda-item {
            display: flex;
            align-items: center;
        }

        .dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 2px;
            vertical-align: middle;
        }

        .dot-pendiente {
            background: #FF9800;
        }

        .dot-confirmada {
            background: #4CAF50;
        }

        .dot-examen {
            background-color: #ef63f8;
        }

        .form {
            max-width: 280px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

            .form-group label {
                min-width: 80px;
                /*margin-right: 8px;*/
                font-size: 13px;
                font-weight: 500;
                text-align: right;
            }

        .input {
            flex: 1;
            padding: 3px 6px;
            border: 1px solid #bbb;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .btn.cta-btn-confirmada {
            width: 100%;
            padding: 6px;
            margin-top: 6px;
            background: #388e3c;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-sizing: border-box;
            min-height: 28px; /* Por si el texto es pequeño */
        }

            .btn.cta-btn-confirmada:hover {
                background: #2e7031;
            }

        .tabla {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            background: #fff;
            box-shadow: 0 2px 8px rgba(25, 103, 210, 0.06);
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
            table-layout: auto; /* O 'fixed' si quieres columnas iguales */
        }

            .tabla th, .tabla td {
                padding: 7px 12px;
                text-align: left;
                border-bottom: 1px solid #e0e0e0;
            }

            .tabla th {
                background: #1976d2;
                color: #fff;
                font-weight: 600;
                letter-spacing: 0.5px;
                font-size: 14px;
            }

                .tabla th:nth-child(54), .tabla td:nth-child(5) {
                    width: 60px;
                    min-width: 40px;
                    max-width: 70px;
                    text-align: center;
                    padding-right: 0;
                    padding-left: 0;
                }


            .tabla tr:last-child td {
                border-bottom: none;
            }

            .tabla tr:nth-child(even) td {
                background: #f5f7fa;
            }

            .tabla tr:hover td {
                background: #e3f2fd;
                transition: background 0.2s;
            }

        @media (max-width: 600px) {
            .tabla, .tabla th, .tabla td {
                font-size: 12px;
                padding: 6px 8px;
            }
        }

        .reserva-hora {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 1px 4px;
            margin-bottom: 2px;
            background: #f5f7fa;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1;
            box-shadow: none;
            transition: background 0.2s;
            min-height: 0;
        }

            .reserva-hora:hover {
                background: #e3f2fd;
            }

            .reserva-hora .hora {
                font-weight: 500;
                color: #1976d2;
                min-width: 36px;
                line-height: 1;
                padding: 0 1px;
            }

            .reserva-hora .estado {
                font-size: 10px;
                font-weight: 600;
                padding: 0 5px;
                border-radius: 7px;
                margin-left: auto;
                text-transform: capitalize;
                line-height: 1;
                height: 16px;
                display: flex;
                align-items: center;
            }

                /* Colores de estado */
                .reserva-hora .estado.confirmada {
                    background: #c8e6c9;
                    color: #388e3c;
                    border: 1px solid #388e3c;
                }

                .reserva-hora .estado.pendiente {
                    background: #fff9c4;
                    color: #fbc02d;
                    border: 1px solid #fbc02d;
                }

                .reserva-hora .estado.anulada {
                    background: #ffcdd2;
                    color: #d32f2f;
                    border: 1px solid #d32f2f;
                }

                .reserva-hora .estado.examen {
                    background: #e0e0e0;
                    color: #ef63f8;
                    border: 1px solid #757575;
                }


        #lista-reservas-dia, #datosAlumno, .reservasdia {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centra horizontalmente los hijos */
        }

        .eliminar-alumno {
            cursor: pointer;
            font-size: 18px;
            color: #d32f2f;
            transition: color 0.2s;
        }

            .eliminar-alumno:hover {
                color: #b71c1c;
            }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .popup-content {
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close, .closepopup {
            float: right;
            cursor: pointer;
            font-size: 24px;
        }



        .log-creditos-item {
            margin: 8px 0;
            padding: 8px;
            background: #f5f7fa;
            border-radius: 6px;
        }

        .creditos-alumno {
            cursor: pointer; /* Mano al pasar el mouse */
            font-weight: 600;
            transition: color 0.2s;
            text-align: center;
        }

            .creditos-alumno:hover {
                text-decoration: underline;
            }

            .creditos-alumno[data-creditos="0"] {
                color: #d32f2f; /* Rojo si es 0 */
            }

            .creditos-alumno:not([data-creditos="0"]) {
                color: #388e3c; /* Verde si no es 0 */
            }

        #logCreditosTabla.tabla {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            background: #fff;
            box-shadow: 0 2px 8px rgba(25, 103, 210, 0.06);
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
        }

            #logCreditosTabla.tabla th, #logCreditosTabla.tabla td {
                padding: 7px 12px;
                text-align: left;
                border-bottom: 1px solid #e0e0e0;
            }

            #logCreditosTabla.tabla th {
                background: #1976d2;
                color: #fff;
                font-weight: 600;
            }

            #logCreditosTabla.tabla tr:last-child td {
                border-bottom: none;
            }

            #logCreditosTabla.tabla tr:nth-child(even) td {
                background: #f5f7fa;
            }

        th.eliminar-col, td.eliminar-col {
            width: 40px;
            min-width: 40px;
            max-width: 40px;
            text-align: center;
            padding: 0;
        }

        .borrar-log {
            cursor: pointer;
            font-size: 18px;
            color: #d32f2f;
            transition: color 0.2s;
        }

            .borrar-log:hover {
                color: #b71c1c;
            }

        @media (max-width: 600px) {
            .tabla-responsive {
                overflow-x: auto;
                display: block;
            }
        }

        #logCreditosTabla th, #logCreditosTabla td {
            padding: 4px 8px;
            font-size: 0.95em;
        }

        .fc-today-button {
            display: none !important;
        }

        .btn-admin {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 6px auto; /* Centrado con margen vertical */
            background: linear-gradient(90deg, #1976d2 60%, #63a4ff 100%);
            color: #fff;
            text-decoration: none;
            padding: 4px 6px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.13);
            border: none;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s, color 0.2s, transform 0.1s;
            min-width: 150px;
            max-width: 100%;
        }

            .btn-admin:hover {
                background: linear-gradient(90deg, #1565c0 40%, #1976d2 100%);
                box-shadow: 0 8px 24px rgba(25, 118, 210, 0.21);
                color: #fff;
                transform: scale(1.05);
            }

        .btn-ayuda {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #1976d2;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .popup-content {
            background: #fff;
            padding: 28px 32px;
            border-radius: 16px;
            max-width: 640px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            transform: translateY(0);
            animation: fadeInUp 0.4s ease-out;
            border: 1px solid rgba(25,118,210,0.1);
        }

            .popup-content h2 {
                font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
                font-size: 1.7rem;
                font-weight: 700;
                color: #1976d2;
                margin-top: 0;
                margin-bottom: 20px;
                text-align: center;
            }

            .popup-content h3 {
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 1.2rem;
                font-weight: 600;
                color: #1976d2;
                margin: 16px 0 8px 0;
            }

        #contenedor-pdf {
            width: 100%;
            display: none;
        }

        .divpdfh, .divZum {
            text-align: center;
            margin-bottom: 12px;
            font-size: 0.9em;
            color: #6f4683;
        }

        .div-pdf {
            display: grid;
            grid-template-columns: max-content repeat(5, minmax(50px, 1fr));
            gap: 1px;
            background-color: #e3eafc;
            border-radius: 7px;
            overflow: hidden;
        }

        .time-slot {
            background-color: #e3eafc;
            padding: 2px 8px;
            border-bottom: 1px solid #dde6f3;
            text-align: right;
            font-weight: 600;
            font-size: 1em;
            font-family: 'Open Sans', 'Segoe UI', Arial, sans-serif;
            color: #1976d2;
            letter-spacing: 0.5px;
            white-space: nowrap;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }


        .day-header {
            background-color: #1976d2;
            color: #fff;
            padding: 2px 0;
            text-align: center;
            font-weight: 500;
            font-size: 0.96em;
            border-bottom: 2px solid #1565c0;
            min-width: 0;
        }

        .calendar-cell {
            padding: 0 1px;
            background-color: #fff;
            border-bottom: 1px solid #e3eafc;
            min-height: 0;
            height: auto;
            position: relative;
            box-sizing: border-box;
        }

        .reserva.confirmada {
            background-color: #C8E6C9;
            border-color: #4CAF50;
            text-align: center;
        }        

        .reserva.examen {
            background-color: #ef63f8;
            border-color: #4c4c4c;
            text-align:center;
        }

        .cta-btn-parte {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 6px auto; /* Centrado con margen vertical */
            background: linear-gradient(90deg, #1976d2 60%, #63a4ff 100%);
            color: #fff;
            text-decoration: none;
            padding: 4px 6px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.13);
            border: none;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s, color 0.2s, transform 0.1s;
            min-width: 150px;
            max-width: 100%;
        }

            .cta-btn-parte:hover {
                background: linear-gradient(90deg, #1565c0 40%, #1976d2 100%);
                box-shadow: 0 8px 24px rgba(25, 118, 210, 0.21);
                color: #fff;
                transform: scale(1.05);
            }
    </style>
</head>
<body class="oculto">
    <div class="container">
        <h2 class="cabecera-principal" id="tituloReservas"></h2>
        <!--<div id="subcabecera-creditos" class="subcabecera-creditos">
          <span id="creditosUsuario">...</span>
        </div>-->
        <div class="arriba">
            <div id="columna-alumnos" class="columna-alumnos">
                <div class="nuevoalumno">
                    <h2 class="cabecera">Nuevo alumno</h2>
                    <form id="formAlumno" class="form" onsubmit="return false;">
                        <div class="form-group">
                            <label for="emailAlumno">Email</label>
                            <input type="email" id="emailAlumno" class="input" required>
                        </div>
                        <div class="form-group">
                            <label for="apellidosAlumno">Apellidos</label>
                            <input type="text" id="apellidosAlumno" class="input" required>
                        </div>
                        <div class="form-group">
                            <label for="nombreAlumno">Nombre</label>
                            <input type="text" id="nombreAlumno" class="input" required>
                        </div>
                        <button type="button" class="btn cta-btn-confirmada" onclick="agregarAlumno()">Registrar alumno</button>
                    </form>
                    <div id="msgAlumno"></div>
                </div>
                <div class="listadoalumno">
                    <h2 class="cabecera">Listado de alumnos</h2>
                    <div id="listadoAlumnos"></div>
                    <div id="form-group"></div>
                    <div id="msgAlumno"></div>
                </div>
            </div>
            <div id="calendar-container">
                <div id="calendar"></div>
                <!-- Leyenda de colores -->
                <div class="leyenda-colores">
                    <span class="leyenda-item"><span class="dot dot-pendiente"></span>Pendiente</span>
                    <span class="leyenda-item"><span class="dot dot-confirmada"></span>Confirmada</span>
                    <span class="leyenda-item"><span class="dot dot-examen"></span>Examen</span>
                </div>
                <div><button id="descargar-pdf" class="cta-btn-parte">Parte semanal</button></div>
                <div id="contenedor-pdf"><div class="div-pdf" id="div-pdf"></div></div>
                <div class="seccion-derecha">
                    <div class="reservas-dia">
                        <h2 class="cabecera" id="tituloReservasDia">Reservas del día</h2>
                        <div id="lista-reservas-dia"></div>
                    </div>
                    <button id="btnAyuda" class="btn-ayuda">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="popupAyuda" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h2>Ayuda</h2>
            <div id="contenidoAyuda">
                <!-- Aquí va el contenido de ayuda específico para cada página -->
            </div>
        </div>
    </div>

    <div id="popupCreditos" class="popup">
        <div class="popup-content">
            <span class="closepopup">&times;</span>
            <h2 class="cabecera" id="titulocreditos"></h2>
            <div id="datosAlumno" class="tabla-responsive"></div>
            <!--<div id="logCreditos"></div>-->
            <table id="logCreditosTabla" class="tabla">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Perfil</th>
                        <th>Antes</th>
                        <th>Reserva o Anulación</th>
                        <th>Despues</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se insertarán las filas dinámicamente -->
                </tbody>
            </table>
            <form id="formSumarCreditos">
                <input type="hidden" id="alumnoId">
                <label for="paqueteCreditos">Paquetes de clases:</label>
                <select id="paqueteCreditos">
                    <option value="5">5 clases</option>
                    <option value="3">3 clases</option>
                    <option value="1">1 clase</option>
                    <!-- Añade más opciones si lo necesitas -->
                </select>
                <button class="btn cta-btn-confirmada" type="submit">Añadir clases</button>
            </form>
            <div id="msgClases"></div>
        </div>
    </div>
    <script>

        const settings = { experimentalForceLongPolling: true, merge: true };
        db.settings(settings);

        let calendar = null;
        let primeraCarga = true;
        let reservasTodas = {};
        let reservasUsuario = [];
        let eventos = [];

        async function agregarAlumno() {
            const email = document.getElementById('emailAlumno').value.trim();
            const apellidos = document.getElementById('apellidosAlumno').value.trim();
            const nombre = document.getElementById('nombreAlumno').value.trim();
            const msg = document.getElementById('msgAlumno');

            // Validación simple
            if (!email || !apellidos || !nombre) {
                msg.textContent = "Por favor, completa todos los campos.";
                msg.style.color = "#d32f2f";
                return;
            }

            // Validación de formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                msg.textContent = "El email no tiene un formato válido.";
                msg.style.color = "#d32f2f";
                return;
            }

            try {
                // Añadir nuevo alumno a Firestore
                await db.collection('usuarios_registrados').add({
                    email: email,
                    Apellidos: apellidos,
                    nombre: nombre,
                    perfil: "alumno",
                    creditos: 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                msg.textContent = "Alumno registrado correctamente.";
                msg.style.color = "#388e3c";
                document.getElementById('formAlumno').reset();

                // Actualizar listado de alumnos
                if (typeof cargarListadoAlumnos === "function") cargarListadoAlumnos();
            } catch (error) {
                msg.textContent = "Error al registrar alumno: " + error.message;
                msg.style.color = "#d32f2f";
            }
        }

        async function cargarListadoAlumnos() {
            const contenedor = document.getElementById('listadoAlumnos');
            contenedor.innerHTML = "Cargando...";

            try {
                const snapshot = await db.collection('usuarios_registrados')
                    .where("perfil", "==", "alumno")
                    .orderBy("Apellidos")
                    .get();

                if (snapshot.empty) {
                    contenedor.innerHTML = "<p>No hay alumnos registrados.</p>";
                    return;
                }

                // Puedes mostrarlo como tabla o lista
                let html = `<table class="tabla">
                        <tr>
                            <th>Acción</th>
                            <!--<th>Email</th>-->
                            <th>Apellidos</th>
                            <th>Nombre</th>
                            <th>Clases</th>
                        </tr>`;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `<tr>
                            <td><span class="eliminar-alumno" data-id="${doc.id}">🗑️</span></td>
                            <!--<td>${data.email}</td>-->
                            <td>${data.Apellidos || ''}</td>
                            <td>${data.nombre || ''}</td>
                            <td class="creditos-alumno" data-id="${doc.id}" data-usuarioiId="${data.usuarioId}" data-creditos="${data.creditos}">${typeof data.creditos === "number" ? data.creditos : 0}</td>
                        </tr>`;
                });
                html += `</table>`;
                contenedor.innerHTML = html;

                // Añade el listener para el borrado
                document.querySelectorAll('.eliminar-alumno').forEach(icono => {
                    icono.addEventListener('click', eliminarAlumno);
                });

                // Asigna el listener a las clases
                document.querySelectorAll('.creditos-alumno').forEach(celda => {
                    celda.addEventListener('click', abrirPopupCreditos);
                });
            } catch (error) {
                contenedor.innerHTML = `<p style="color:#d32f2f">Error al cargar alumnos: ${error.message}</p>`;
            }
        }

        async function eliminarAlumno(event) {
            const id = event.currentTarget.getAttribute('data-id');
            const confirmar = confirm('¿Seguro que quieres eliminar este alumno?');
            if (confirmar) {
                try {
                    await db.collection('usuarios_registrados').doc(id).delete();
                    //alert('Alumno eliminado correctamente');
                    cargarListadoAlumnos(); // Recarga la lista
                } catch (error) {
                    alert('Error al eliminar alumno: ' + error.message);
                }
            }
        }

        // Variables globales
        let alumnoActualId = null;
        let usuarioId = null;

        // Abrir popup
        async function abrirPopupCreditos(event) {
            alumnoActualId = event.currentTarget.getAttribute('data-id');
            usuarioId = event.currentTarget.getAttribute('data-usuarioiId');
            const popup = document.getElementById('popupCreditos');
            document.getElementById('alumnoId').value = alumnoActualId;
            popup.style.display = 'flex';

            // Cargar datos del alumno
            const alumnoDoc = await db.collection('usuarios_registrados').doc(alumnoActualId).get();
            const alumno = alumnoDoc.data();
            //document.getElementById('datosAlumno').innerHTML = `<p><strong>Nombre:</strong> ${alumno.nombre}</p><p><strong>Apellidos:</strong> ${alumno.apellidos}</p><p><strong>Email:</strong> ${alumno.email}</p>`;
            document.getElementById('titulocreditos').innerHTML = `Historial de clases para ${alumno.nombre}`;
            //console.log(alumnoActualId);
            // Cargar log de créditos (colección independiente)
            const logSnapshot = await db.collection('logcreditos')
                .where('usuarioId', '==', usuarioId)
                .orderBy('fecha', 'asc')
                .get();

            const tbody = document.querySelector('#logCreditosTabla tbody');
            tbody.innerHTML = '';
            if (logSnapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="5">No hay historial de clases</td></tr>';
            } else {
                // Si necesitas el crédito puntual en cada momento, deberías calcularlo acumulando las operaciones
                //console.log(usuarioActual.perfil);
                let acumulado = 0;
                logSnapshot.forEach(doc => {
                    const log = doc.data();
                    const fecha = log.fecha.toDate();
                    acumulado += log.tipo === 'sumar' ? log.reservasImplicadas.length : -log.reservasImplicadas.length;
                    const fila = `
                        <tr>
                            <td>${fecha.toLocaleDateString('es-ES')}</td>
                            <td>${fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</td>
                            <td>${log.perfil || '-'}</td>
                            <td>${log.creditosAntes}</td>
                            <td>${log.tipo === 'sumar' ? '+' + log.reservasImplicadas.length : log.tipo === 'confirmar' ? 'confirmada' : '-' + log.reservasImplicadas.length}</td>
                            <td>${log.creditosDespues}</td>
                            ${log.perfil === "administracion" ? `<td class="eliminar-col"><span class="borrar-log" data-logid="${doc.id}" data-cantidad="${log.reservasImplicadas.length}">🗑️</span></td>` : ''}
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', fila);
                });

                // Añade la fila totalizadora al final
                const totalizador = `
                <tr style="font-weight:bold;">
                    <td colspan="5" style="text-align:right;">Clases actuales:</td>
                    <td>${alumno.creditos}</td>
                </tr>
            `;
                tbody.insertAdjacentHTML('beforeend', totalizador);
            }

        }


        // Cerrar popup
        document.querySelector('.closepopup').addEventListener('click', () => {
            document.getElementById('popupCreditos').style.display = 'none';
            msgClases.innerHTML = "";
        });

        document.getElementById('formSumarCreditos').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('alumnoId').value;
            const clases = parseInt(document.getElementById('paqueteCreditos').value);

            let creditosAntes = 0;
            let creditosDespues = 0;
            let alumno = null;
            //let usuarioId = null;

            // Sumar clases al alumno en una transacción
            await db.runTransaction(async (transaction) => {
                const alumnoRef = db.collection('usuarios_registrados').doc(id);
                const alumnoDoc = await transaction.get(alumnoRef);
                alumno = alumnoDoc.data();
                creditosAntes = alumno.creditos || 0;
                creditosDespues = creditosAntes + clases;
                //usuarioId = alumno.usuarioId; // Asegúrate de que este campo existe en el documento
                transaction.update(alumnoRef, { creditos: creditosDespues });
            });

            // Añadir entrada al log de créditos (fuera de la transacción)
            await db.collection('logcreditos').add({
                usuarioId: usuarioId,
                email: alumno.email,
                perfil: usuarioActual.perfil,
                creditosAntes: creditosAntes,
                tipo: "sumar",
                creditosDespues: creditosDespues,
                reservasImplicadas: Array(clases).fill({}), // O ajusta según tu lógica
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            });

            msgClases.style.color = "#388e3c";
            msgClases.innerHTML = "Clase/s añadida/s correctamente.";
            await abrirPopupCreditos({ currentTarget: { getAttribute: (attr) => attr === "data-id" ? id : usuarioId } });
            cargarListadoAlumnos(); // Actualizar tabla
        });

        document.querySelector('#logCreditosTabla tbody').addEventListener('click', async function (event) {
            if (event.target.classList.contains('borrar-log')) {
                const logId = event.target.getAttribute('data-logid');
                const cantidad = parseInt(event.target.getAttribute('data-cantidad'), 10);
                // Recupera el documento del log
                const logDoc = await db.collection('logcreditos').doc(logId).get();
                const log = logDoc.data();
                if (log.tipo !== "sumar") {
                    alert("Solo se pueden borrar operaciones de suma.");
                    return;
                }
                // Confirmación
                if (!confirm(`¿Seguro que quieres borrar este registro y restar ${cantidad} clase(s)?`)) return;

                // Transacción: borrar log y restar créditos
                const alumnoRef = db.collection('usuarios_registrados').doc(alumnoActualId);
                await db.runTransaction(async (transaction) => {
                    const alumnoDoc = await transaction.get(alumnoRef);
                    const creditosActuales = alumnoDoc.data().creditos || 0;
                    const creditosDespues = Math.max(0, creditosActuales - cantidad);
                    transaction.update(alumnoRef, { creditos: creditosDespues });
                    transaction.delete(db.collection('logcreditos').doc(logId));
                });

                // Recarga el popup para reflejar los cambios

                msgClases.style.color = "#388e3c";
                msgClases.innerHTML = "Clase/s eliminada/s correctamente.";
                await abrirPopupCreditos({
                    currentTarget: {
                        getAttribute: (attr) => {
                            if (attr === "data-id") return alumnoActualId;
                            if (attr === "data-usuarioiId") return usuarioId; // Asegúrate de tener este valor disponible
                            return null;
                        }
                    }
                });
                cargarListadoAlumnos(); // Actualizar tabla
            }
        });


        function capitalizarPrimeraLetra(str) {
            return str.replace(/\b\w/g, function (char) {
                return char.toUpperCase();
            });
        }

        // Utilidad: formato YYYY-MM-DD
        function toISODate(date) {
            return date.toISOString().split('T')[0];
        }

        // Cargar días de la semana actual y la siguiente
        function cargarDias() {
            const selectDia = document.getElementById('dia');
            selectDia.innerHTML = "";
            const hoy = new Date();
            for (let i = 1; i < 15; i++) {
                const fecha = new Date(hoy);
                fecha.setDate(hoy.getDate() + i);
                const diaSemana = fecha.getDay(); // 0=domingo, 6=sábado
                if (diaSemana !== 0 && diaSemana !== 6) { // Excluye sábados y domingos
                    const fechaISO = toISODate(fecha);
                    const texto = fecha.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                    const option = document.createElement('option');
                    option.value = fechaISO;
                    option.textContent = texto.charAt(0).toUpperCase() + texto.slice(1);
                    selectDia.appendChild(option);
                }

            }
        }

        // Función para cargar reservas del día
        async function cargarReservasDelDia(fechaStr) {
            const lista = document.getElementById('lista-reservas-dia');
            lista.innerHTML = '<div class="cargando">Cargando...</div>';

            try {
                // Actualizar título con formato "Reservas del lunes, 12 de mayo"
                const tituloDia = document.getElementById('tituloReservasDia');
                if (tituloDia) {
                    const fecha = new Date(fechaStr);
                    tituloDia.textContent = `Reservas del ${fecha.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long'
                    })}`;
                }

                // Consulta a Firestore (sin ordenar)
                const fechaInicio = new Date(fechaStr + 'T00:00:00');
                const fechaFin = new Date(fechaStr + 'T23:59:59');
                const q = db.collection("reservas")
                    .where("fecha", ">=", fechaInicio)
                    .where("fecha", "<=", fechaFin)
                    .where('estado', 'in', ['confirmada', 'pendiente', 'examen']); // Solo estos estados
                
                const querySnapshot = await q.get();

                if (querySnapshot.empty) {
                    lista.innerHTML = '<div class="sin-reservas"><em>No hay reservas este día</em></div>';
                    return;
                }

                // Convertir documentos a array
                const reservas = [];
                querySnapshot.forEach(doc => {
                    const reserva = doc.data();
                    reserva.id = doc.id;
                    reservas.push(reserva);
                    //console.log(reserva.usuarioNombre);
                });
                //console.table(reservas);
                // Obtener usuarioIds únicos
                const usuarioIds = [...new Set(reservas.map(r => r.usuarioId))];
                
                // Consultar los usuarios (en lotes de 10)
                let usuarios = {};
                for (let i = 0; i < usuarioIds.length; i += 10) {
                    const batchIds = usuarioIds.slice(i, i + 10);
                    const usuariosSnapshot = await db.collection("usuarios_registrados")
                        .where("usuarioId", "in", batchIds)
                        .get();
                    
                    usuariosSnapshot.forEach(doc => {
                        const data = doc.data();                        
                        usuarios[data.usuarioId] = {
                            nombre: data.nombre,
                            apellidos: data.Apellidos
                        };
                    });
                }
                //console.table(usuarios);

                // Añadir nombre y apellidos a cada reserva
                reservas.forEach(reserva => {
                    reserva.nombre = usuarios[reserva.usuarioId]?.nombre || "";
                    reserva.apellidos = usuarios[reserva.usuarioId]?.apellidos || "";
                });

                // Ordenar por hora de inicio (ascendente)
                reservas.sort((a, b) => horaAminutos(a.hora) - horaAminutos(b.hora));

                // Mostrar en el DOM
                lista.innerHTML = '';
                reservas.forEach(reserva => {
                    const div = document.createElement('div');
                    div.className = `reserva-dia-item ${reserva.estado}`;

                    div.innerHTML = `
                            <div class="reserva-hora">
                                <span class="hora">${reserva.hora}</span>&nbsp;&nbsp;&nbsp;
                                <span class="hora">${reserva.nombre}</span>&nbsp;
                                <span class="hora">${reserva.apellidos}</span>&nbsp;&nbsp;&nbsp;
                                <span class="estado ${reserva.estado}">${reserva.estado}</span>
                            </div>
                        `;
                    lista.appendChild(div);
                });

            } catch (error) {
                console.error("Error:", error);
                lista.innerHTML = '<div class="error">Error al cargar reservas</div>';
            }
        }


        function horaAminutos(horaRango) {
            try {
                const [inicio] = horaRango.split(' a '); // Extrae la hora inicial
                const [hora, minutos] = inicio.split(':').map(Number);
                return hora * 60 + minutos;
            } catch (error) {
                console.error("Error al parsear la hora:", horaRango);
                return 0; // Si hay error, trata como 0 minutos (puedes ajustarlo)
            }
        }


        function mostrarEventosDelDia(fechaStr) {
            const eventos = calendar.getEvents();
            const eventosDelDia = eventos.filter(evento => {
                const inicio = evento.start?.toISOString().split('T')[0];
                return inicio === fechaStr;
            });

            //console.log("Eventos en", fechaStr, ":", eventosDelDia);
        }

        // Inicializar FullCalendar
        function inicializarCalendario() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                alert("No se encontró el div con id 'calendar'");
                return;
            }

            const fechaActual = new Date(); // O fija la fecha si es para pruebas
            const year = fechaActual.getFullYear();
            const month = fechaActual.getMonth(); // 0-indexed

            // Primer día del mes actual
            const start = new Date(year, month, 1);
            // Último día del mes siguiente
            const end = new Date(year, month + 2, 0); // Día 0 del mes+2 es el último del mes+1

            calendar = new FullCalendar.Calendar(calendarEl, {
                //plugins: [dayGridPlugin, interactionPlugin],
                initialView: 'dayGridMonth',
                locale: 'es',
                titleFormat: { year: 'numeric', month: 'long' },
                firstDay: 1,
                validRange: {
                    start: start.toISOString().split('T')[0],
                    end: end.toISOString().split('T')[0]
                },
                //height: 'auto',
                aspectRatio: 0.8, // Menor = más compacto verticalmente
                fixedWeekCount: false, // Elimina filas vacías
                expandRows: false, // Evita que las filas se expandan
                //events: [],
                dateClick: function (info) {
                    cargarReservasDelDia(info.dateStr);
                },
                dayCellContent: function (info) {
                    // Corrige la fecha para la zona horaria local
                    const fechaLocal = new Date(info.date.getTime() - (info.date.getTimezoneOffset() * 60000)).toISOString().slice(0, 10); // Formato YYYY-MM-DD local

                    // 2. Verifica que la fecha exista en reservasTodas
                    const reservas = reservasTodas[fechaLocal] || { confirmadas: 0, pendientes: 0, examen: 0 };
                    let dotp = '', dotc = '', dote = '';
                    if (reservas.examen > 0) {
                        dote = `<span style = "display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #ef63f8;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.examen}</span>`;
                    }
                    if (reservas.pendientes > 0) {
                        dotp = `<span style = "display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #FF9800;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.pendientes}</span>`;
                    }
                    if (reservas.confirmadas > 0) {
                        dotc = `<span style = "display: inline-flex;justify-content: center;align-items: center;width: 18px;height: 18px;border-radius: 50%;background: #4CAF50;color: white;font-size: 12px;font-weight: bold;margin-left: 4px;vertical-align: middle;line-height: 1;">${reservas.confirmadas}</span>`;
                    }                    
                    return { html: info.dayNumberText + dote + dotp + dotc };
                }
            });
            calendar.render();
        }

        // Mostrar todas las reservas en el calendario
        function mostrarReservasCalendario() {
            calendar.removeAllEvents();

            const eventos = Object.values(reservasTodas)
                .flatMap(reservasDelDia => {
                    // Si reservasDelDia tiene la propiedad 'reservas' y es un array:
                    if (reservasDelDia && Array.isArray(reservasDelDia.reservas)) {
                        return reservasDelDia.reservas
                            .filter(r => ['confirmada', 'pendiente', 'examen'].includes(r.estado)) // Incluye "examen"
                            .map(r => ({
                                start: r.fecha.toDate ? r.fecha.toDate() : r.fecha,
                                backgroundColor:
                                    r.estado === 'confirmada' ? '#4CAF50' :
                                        r.estado === 'examen' ? '#1976d2' : // Color especial para examen
                                            '#FF9800',
                                textColor: '#fff'
                            }));
                    }
                    // Si reservasDelDia ES un array directamente:
                    if (Array.isArray(reservasDelDia)) {
                        return reservasDelDia
                            .filter(r => ['confirmada', 'pendiente', 'examen'].includes(r.estado))
                            .map(r => ({
                                start: r.fecha.toDate ? r.fecha.toDate() : r.fecha,
                                backgroundColor:
                                    r.estado === 'confirmada' ? '#4CAF50' :
                                        r.estado === 'examen' ? '#1976d2' :
                                            '#FF9800',
                                textColor: '#fff'
                            }));
                    }
                    return [];
                });

            calendar.addEventSource(eventos);
        }


        // Mostrar reservas del usuario autenticado
        function mostrarReservasUsuario() {
            const lista = document.getElementById('lista-reservas');
            lista.innerHTML = "";
            if (reservasUsuario.length === 0) {
                lista.innerHTML = "<em>No tienes reservas aún.</em>";
                return;
            }
            reservasUsuario
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
                .forEach(r => {
                    const div = document.createElement('div');
                    div.className = `reserva-item ${r.estado}`;
                    const fechaTexto = new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
                    if (r.estado == 'pendiente') div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">📅 ${new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</span ><span class="reserva-hora">⏰ ${r.hora}</span ><button onclick="anularReserva('${r.fecha}', '${r.hora}', 'pendiente')" class='cta-btn-pendiente'>anular</button></div>`;
                    //if (r.estado == 'confirmada') div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">📅 ${new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</span ><span class="reserva-hora">⏰ ${r.hora}</span ><div class='cta-btn'style ='background: linear-gradient(90deg, #56ab2f 30%, #a8e063 100%); box-shadow: 0 4px 16px rgba(255, 65, 108, 0.15);'>confirmada</div></div>`;
                    if (r.estado == 'confirmada') {

                        if (esMenosDe24Horas(r.fecha, r.hora)) {
                            // Botón deshabilitado
                            div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">📅 ${fechaTexto}</span><span class="reserva-hora">⏰ ${r.hora}</span><button disabled class='cta-btn-confirmada-disabled' title="No se puede anular a menos de 24h o reservas pasadas">confirmada</button></div>`;
                        } else {
                            div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">📅 ${new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</span ><span class="reserva-hora">⏰ ${r.hora}</span ><button onclick="anularReserva('${r.fecha}', '${r.hora}', 'confirmada')" class='cta-btn-confirmada'>confirmada</button></div>`;

                        }
                    }
                    //if (r.estado == 'anulada') div.innerHTML = `<div class="reserva-item-compacta"><span class="reserva-fecha">📅 ${new Date(r.fecha).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</span ><span class="reserva-hora">⏰ ${r.hora}</span ><div class='cta-btn'style ='background: linear-gradient(90deg, #ff6a6a 30%, #ffe0e0 100%);'>anulada</div></div>`;

                    lista.appendChild(div);
                });
        }

        // Función para saber si faltan menos de 24h para la reserva
        function esMenosDe24Horas(fechaStr, horaStr) {
            // fechaStr: 'YYYY-MM-DD', horaStr: 'HH:MM a HH:MM'
            const ahora = new Date();
            const [anio, mes, dia] = fechaStr.split('-').map(Number);
            const horaInicioStr = horaStr.split('a')[0].trim(); // "HH:MM"
            const [h, m] = horaInicioStr.split(':').map(Number);
            const fechaHoraReserva = new Date(anio, mes - 1, dia, h, m, 0, 0);
            const diferenciaMs = fechaHoraReserva - ahora;
            const horasRestantes = diferenciaMs / (1000 * 60 * 60);
            return horasRestantes < 24;
        }

        async function cargarReservas() {
            // Todas las reservas para el calendario
            db.collection('reservas').onSnapshot(snapshot => {
                reservasTodas = {};
                snapshot.forEach(doc => {
                    const reserva = doc.data();
                    //console.log(reserva);
                    if (reserva.fecha?.toDate) { // Validar existencia de fecha
                        const fechaDate = reserva.fecha.toDate();
                        // Convertir a fecha local (ej: España)
                        const fechaStr = fechaDate.toLocaleDateString("es-ES", {
                            timeZone: "Europe/Madrid",
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit"
                        }).split("/").reverse().join("-"); // Formato YYYY-MM-DD

                        if (!reservasTodas[fechaStr]) {
                            reservasTodas[fechaStr] = { confirmadas: 0, pendientes: 0, examen: 0 };
                        }

                        if (reserva.estado === 'confirmada') reservasTodas[fechaStr].confirmadas++;
                        if (reserva.estado === 'pendiente') reservasTodas[fechaStr].pendientes++;
                        if (reserva.estado === 'examen') reservasTodas[fechaStr].examen++;
                        //console.log("Datos cargados (LOCALES):", reservasTodas);
                    } else {
                        console.error("Documento sin campo 'fecha':", doc.id);
                    }

                    //console.log("Datos actualizados (LOCALES):", reservasTodas);
                    if (calendar) calendar.refetchEvents(); // Actualizar calendario
                });

                // Solo inicializa el calendario la primera vez
                if (primeraCarga) {
                    inicializarCalendario();
                    primeraCarga = false;
                }
                //console.table(reservasTodas);
                //console.log("Datos actualizados:", reservasTodas);
                mostrarReservasCalendario();
            });


            // Reservas del usuario autenticado
            /*db.collection('reservas')
                .where('usuarioId', '==', usuarioActual.uid)
                .onSnapshot(snapshot => {
                    reservasUsuario = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.fecha?.toDate) { // <-- Añade validación aquí
                            reservasUsuario.push({
                                ...d,
                                fecha: d.fecha.toDate().toISOString().split('T')[0],
                                id: doc.id
                            });
                        } else {
                            console.error("Documento del usuario sin 'fecha' válida:", doc.id);
                        }
                    });
                    mostrarReservasUsuario();
                });*/
        }


        function parseFechaFirestore(fechaStr) {
            // Traducir el mes de español a inglés
            const meses = {
                'enero': 'Enero', 'febrero': 'Febrero', 'marzo': 'Marzo', 'abril': 'Abril', 'mayo': 'Mayo',
                'junio': 'Junio', 'julio': 'Julio', 'agosto': 'Agosto', 'septiembre': 'Septiembre', 'octubre': 'Octubre',
                'noviembre': 'Noviembre', 'diciembre': 'Diciembre'
            };
            let fechaEn = fechaStr;
            for (let [es, en] of Object.entries(meses)) {
                if (fechaEn.includes(es)) {
                    fechaEn = fechaEn.replace(es, en);
                    break;
                }
            }
            // Eliminar 'UTC+2' y ajustar am/pm
            fechaEn = fechaEn.split(' UTC')[0]
                .replace(' a.m.', ' AM')
                .replace(' p.m.', ' PM')
                .replace(' de ', ' ');

            // Parsear a Date
            // Ejemplo: '12 May 2025, 2:00:00 AM'
            const fechaDate = new Date(Date.parse(fechaEn));

            // Ajustar a UTC si es necesario (ejemplo: restar 2 horas si era UTC+2)
            // En este ejemplo, la hora ya está en local, así que para UTC:
            fechaDate.setHours(fechaDate.getHours() - 2);

            return fechaDate;
        }

        async function logCredito({
            usuarioId,
            email,
            perfil,
            creditosAntes,
            tipo, // "sumar" o "restar"
            creditosDespues,
            reservasImplicadas
        }) {
            try {
                await db.collection("logcreditos").add({
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    usuarioId,
                    email,
                    perfil,
                    creditosAntes,
                    tipo,
                    creditosDespues,
                    reservasImplicadas
                });
                console.log("Log de crédito guardado correctamente");
            } catch (error) {
                console.error("Error al guardar el log de créditos:", error);
            }
        }

        const btnAyuda = document.getElementById('btnAyuda');
        const popupAyuda = document.getElementById('popupAyuda');
        const closeBtn = document.querySelector('.close');

        const ayudaCalendario = `<h3>Uso de la administracion de reservas para practicas</h3>
<p>Aquí puedes ver todas las reservas solicitadas al profesor de practicas. Asignar un nuevo alumno al profesor. Verás las clases que les quedan a los alumnos por realizar. Añadir o borrar clases a los alumnos. Verás un historico de solicitudes de clases realizadas por los alumnos, ya sean solicitadas, anuladas o confirmadas.</p>
<ul>
        <li><strong>Nuevo alumno:</strong> Podrás añadir un nuevo alumno al profesor.</li>
        <li><strong>Listado de alumnos:</strong> Podrás visualizar el listado de alumnos que tiene asignado el profesor. Borrar alumnos. En clases podrás añadirles y borrarles clases, así como visualizar un historico de los movimientos producidos en la gestion de sus clases.</li>
        <li><strong>Calendario:</strong> Podrás ver todas las peticiones de reservas al profesor de practicas solicitadas por todos los alumnos, ya esten pendientes de confirmar por él, ó bien ya confirmadas.</li>
        <li><strong>Reservas del día:</strong> Si haces clic en una fecha del calendario, visualizaras en este apartado todas las reservas solicitadas por todos los alumnos para ese dia tanto si están pendientes como confirmadas.</li>
</ul>
`;

        btnAyuda.addEventListener('click', () => {
            popupAyuda.style.display = 'flex';
        });

        closeBtn.addEventListener('click', () => {
            popupAyuda.style.display = 'none';
        });

        // Cierra el popup si se hace clic fuera del contenido
        popupAyuda.addEventListener('click', (e) => {
            if (e.target === popupAyuda) {
                popupAyuda.style.display = 'none';
            }
        });

        //----------------------------------------------------------------------------------------------------------
        //crear contenido html de Planificacion.html para crear pdf
        let currentDate = new Date(); // Fecha actual
        currentDate.setHours(0, 0, 0, 0); // Normaliza la hora

        function formatDate(date) {
            // Formatea en hora local (ej: 2025-05-19)
            return date.toLocaleDateString('en-CA'); // Formato "YYYY-MM-DD" en local
        }

        document.getElementById('descargar-pdf').addEventListener('click', function () {
            
            cargarTimeSlots();
            const grid = document.getElementById('div-pdf');
            if (grid) {
                setTimeout(() => {
                    html2pdf()
                        .set({
                            margin: 10,
                            filename: 'ParteSemanal.pdf',
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2 },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        })
                        .from(grid)
                        .save();
                }, 1000);
            } else {
                alert('No se encontró el div.');
            }
        
        });

        // Devuelve array de fechas para la UI
        function getWeekDatesArray(date) {
            const start = new Date(date);
            start.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)); // Lunes
            start.setHours(0, 0, 0, 0);

            const dates = [];
            for (let i = 0; i < 5; i++) { // Solo 5 días (lunes a viernes)
                const current = new Date(start);
                current.setDate(start.getDate() + i);
                dates.push(current);
            }
            return dates;
        }

        // Devuelve { start, end } para consultas
        function getWeekRange(date) {
            const start = new Date(date);
            start.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1));
            start.setHours(0, 0, 0, 0);

            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 59, 999);

            return { start, end };
        }

        let timeSlots = []; // Inicialmente vacío

        async function cargarTimeSlots() {
            try {
                const doc = await db.collection("configuracion").doc("horarios").get();
                if (doc.exists && Array.isArray(doc.data().slots)) {
                    timeSlots = doc.data().slots;

                    // Ordenar los tramos horarios por la hora de inicio
                    timeSlots.sort((a, b) => {
                        // Extrae la hora de inicio (antes del primer espacio o "a")
                        const horaA = a.split(" a ")[0];
                        const horaB = b.split(" a ")[0];
                        // Convierte a minutos para comparar
                        const [hA, mA] = horaA.split(":").map(Number);
                        const [hB, mB] = horaB.split(":").map(Number);
                        return hA * 60 + mA - (hB * 60 + mB);
                    });

                    createCalendar();
                    //cargarHoras();
                } else {
                    console.error("No se encontraron tramos horarios en Firestore.");
                    // Usar valores por defecto si es necesario
                    timeSlots = ["07:30 a 08:50", "09:00 a 10:20", "10:30 a 11:50", "12:00 a 13:20", "13:30 a 14:50"];
                    //updateWeekDisplay();
                    createCalendar();
                }
            } catch (error) {
                console.error("Error al cargar los tramos horarios:", error);
                // Usar valores por defecto si hay error
                timeSlots = ["07:30 a 08:50", "09:00 a 10:20", "10:30 a 11:50", "12:00 a 13:20", "13:30 a 14:50"];
                //updateWeekDisplay();
                createCalendar();
            }
        }

        let examenes = 0;
        let clases = 0;

        async function loadReservations() {
            try {
                
                // Limpia reservas anteriores
                document.querySelectorAll('.reserva').forEach(el => el.remove());

                // Obtén el rango de la semana (para consulta)
                const { start, end } = getWeekRange(currentDate);
                //console.log("Consultando desde:", start, "hasta:", end);

                // Consulta Firestore
                const q = db.collection("reservas")
                    .where("fecha", ">=", firebase.firestore.Timestamp.fromDate(start))
                    .where("fecha", "<=", firebase.firestore.Timestamp.fromDate(end))
                    .where('estado', 'in', ['confirmada', 'pendiente', 'examen']) // Solo estos estados
                    .orderBy('fecha', 'desc');

                const querySnapshot = await q.get();

                // Limpia reservas anteriores
                document.querySelectorAll('.reserva').forEach(el => el.remove());

                // Procesa e inserta en el calendario
                querySnapshot.forEach(doc => {
                    const reserva = doc.data();
                    reserva.id = doc.id;
                    const fecha = reserva.fecha.toDate();
                    const fechaFormateada = formatDate(fecha);
                    const hora = reserva.hora.trim();
                    const estado = reserva.estado.toLowerCase(); // Asegura minúsculas                    
                    const cell = document.querySelector(`[data-date="${fechaFormateada}"][data-hora="${hora}"]`);
                    /*const cells = document.querySelectorAll(`[data-date="${fechaFormateada}"]`);
                    cells.forEach(cell => {
                        console.log('estado:', estado);
                        console.log('fecha Firestore:', fechaFormateada);
                        console.log('Posible hora:', cell.getAttribute('data-hora'));
                        console.log('hora Firestore:', hora);
                    });*/
                    //console.log('Buscando celda:', `[data-date="${fechaFormateada}"][data-hora="${hora}"]`);

                    //console.log('Reserva:', fechaFormateada, hora);
                    //console.log('¿Existe cells?', !!cells, cells);
                    
                                      
                    if (cell) {
                        const reservaElement = document.createElement('div');
                        reservaElement.className = `reserva ${estado}`; // Clase dinámica según estado
                        //reservaElement.innerHTML = `<span>${reserva.usuarioNombre}</span><small>${reserva.estado}</small>`;
                        reservaElement.innerHTML = `<span>${reserva.usuarioNombre}</span>`;
                        reservaElement.dataset.reservaId = reserva.id; // Añade el id
                        reservaElement.dataset.estado = estado;
                        reservaElement.dataset.email = reserva.usuarioEmail || ''; // Si tienes el email                                                   

                        if (estado === 'pendiente' || estado === 'confirmada' || estado === 'examen') {
                            reservaElement.addEventListener('click', function (e) {
                                e.stopPropagation();
                                mostrarMenuContextual(reserva, reservaElement, estado);
                            });
                        }

                        cell.appendChild(reservaElement);

                        if (estado == 'confirmada') clases++;
                        if (estado == 'examen') examenes++;
                    }

                });
                
            } catch (error) {
                console.error("Error al cargar reservas:", error);
            }
        }

        function createCalendar() {
            const grid = document.getElementById('div-pdf');
            grid.innerHTML = '';
            grid.innerHTML = `<div class="divpdfh" style="grid-column: 1 / -1;"><h3>Parte semanal Carlos</h3></div>`;

            const weekDates = getWeekDatesArray(currentDate);

            // 1. Fila del mes (esquina + mes)
            // Obtén el mes y el año del primer día de la semana
            const mes = weekDates[0].toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            // Esquina superior izquierda vacía
            grid.innerHTML += `<div class="time-slot"></div>`;
            // Mes (ocupa 5 columnas, igual que los días)
            grid.innerHTML += `<div class="month-header" style="grid-column: 2 / span 5; text-align:center; font-weight:bold; font-size:1.1em; background:#e3eafc; color:#1976d2; border-radius:6px 6px 0 0;">${mes.charAt(0).toUpperCase() + mes.slice(1)}</div>`;

            // Esquina superior izquierda
            grid.innerHTML += `<div class="time-slot"></div>`;

            // Encabezados de los días de la semana (solo lunes a viernes)
            weekDates.forEach(date => {
                grid.innerHTML += `<div class="day-header">${date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })}</div>`;
            });

            // Filas: cada tramo horario
            timeSlots.forEach(slot => {
                grid.innerHTML += `<div class="time-slot">${slot}</div>`;
                weekDates.forEach(date => {
                    grid.innerHTML += `<div class="calendar-cell" data-date="${formatDate(date)}" data-hora="${slot}"></div>`;
                });
            });

            //loadReservations();            
            //grid.innerHTML += `<div class="divZum" style="grid-column: 1 / -1;"><h3>Total clases = ${clases}</h3><h3>Total Examenes = ${examenes}</h3></div>`;
            loadReservations().then(() => {
                grid.innerHTML += `<div class="divZum" style="grid-column: 1 / -1;"><h3>Total clases = ${clases}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Total Examenes = ${examenes}</h3></div>`;
            });
        }

        async function cargarHoras() {
            // Añade cada tramo como opción
            //console.table(timeSlots);
            //let timeExams = ["08:00 a 08:30", "08:30 a 09:00", "09:00 a 09:30", "09:30 a 10:00", "10:00 a 10:30", "10:30 a 11:00", "11:00 a 11:30"];
            const selectHora = document.getElementById('hora');
            if (!selectHora) return;

            // Limpia las opciones anteriores
            selectHora.innerHTML = '';

            timeSlots.forEach(timeslot => {
                const option = document.createElement('option');
                option.value = timeslot;
                option.textContent = timeslot;
                selectHora.appendChild(option);
            });
        }


    </script>
</body>
</html>
